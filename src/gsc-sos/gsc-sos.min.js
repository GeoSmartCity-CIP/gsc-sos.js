"undefined"==typeof XML&&(XML=function(){});XML.XTree=function(){return this};XML.XTree.prototype.parseXml=function(a){var b=null;if(window.DOMParser)try{b=(new DOMParser).parseFromString(a,"text/xml")}catch(c){b=null}else if(window.ActiveXObject)try{b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a)||console.log(b.parseError.reason+b.parseError.srcText)}catch(d){b=null}else console.log("XML.Xtree: Error on parse XML");return b};
XML.XTree.prototype.toJson=function(a,b){var c={toObj:function(a){var b={},d=function(a){return a.replace(/(?:^\w|[A-Z]|\b\w|\s+)/g,function(a,b){return 0===+a?"":0==b?a.toLowerCase():a.toUpperCase()})};if(1==a.nodeType){if(a.attributes.length)for(var h=0;h<a.attributes.length;h++){var k=-1<a.attributes[h].nodeName.indexOf(":")?a.attributes[h].nodeName.split(":").pop():a.attributes[h].nodeName,k=d(k);b["@"+k]=(a.attributes[h].nodeValue||"").toString()}if(a.firstChild){for(var l=k=0,m=!1,h=a.firstChild;h;h=
h.nextSibling)1==h.nodeType?m=!0:3==h.nodeType&&h.nodeValue.match(/[^ \f\n\r\t\v]/)?k++:4==h.nodeType&&l++;if(m)if(2>k&&2>l)for(c.removeWhite(a),h=a.firstChild;h;h=h.nextSibling)k=h.nodeName,k=k.split(":").pop(),k=d(k),3==h.nodeType?b["#text"]=c.escape(h.nodeValue):4==h.nodeType?b["#cdata"]=c.escape(h.nodeValue):b[k]?b[k]instanceof Array?b[k][b[k].length]=c.toObj(h):b[k]=[b[k],c.toObj(h)]:b[k]=c.toObj(h);else a.attributes.length?b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));else if(k)a.attributes.length?
b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));else if(l)if(1<l)b=c.escape(c.innerXml(a));else for(h=a.firstChild;h;h=h.nextSibling)b["#cdata"]=c.escape(h.nodeValue)}a.attributes.length||a.firstChild||(b=null)}else 9==a.nodeType?b=c.toObj(a.documentElement):alert("unhandled node type: "+a.nodeType);return b},toJson:function(a,b,d){var h=b?'"'+b+'"':"";if(a instanceof Array){for(var k=0,l=a.length;k<l;k++)a[k]=c.toJson(a[k],"",d+"\t");h+=(b?":[":"[")+(1<a.length?"\n"+d+"\t"+a.join(",\n"+
d+"\t")+"\n"+d:a.join(""))+"]"}else if(null==a)h+=(b&&":")+"null";else if("object"==typeof a){k=[];for(l in a)k[k.length]=c.toJson(a[l],l,d+"\t");h+=(b?":{":"{")+(1<k.length?"\n"+d+"\t"+k.join(",\n"+d+"\t")+"\n"+d:k.join(""))+"}"}else h="string"==typeof a?h+((b&&":")+'"'+a.toString()+'"'):h+((b&&":")+a.toString());return h},innerXml:function(a){var b="";if("innerHTML"in a)b=a.innerHTML;else{var c=function(a){var b="";if(1==a.nodeType){for(var b=b+("<"+a.nodeName),d=0;d<a.attributes.length;d++)b+=
" "+a.attributes[d].nodeName+'="'+(a.attributes[d].nodeValue||"").toString()+'"';if(a.firstChild){b+=">";for(d=a.firstChild;d;d=d.nextSibling)b+=c(d);b+="</"+a.nodeName+">"}else b+="/>"}else 3==a.nodeType?b+=a.nodeValue:4==a.nodeType&&(b+="<![CDATA["+a.nodeValue+"]]\x3e");return b};for(a=a.firstChild;a;a=a.nextSibling)b+=c(a)}return b},escape:function(a){return a.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(a){a.normalize();for(var b=
a.firstChild;b;)if(3==b.nodeType)if(b.nodeValue.match(/[^ \f\n\r\t\v]/))b=b.nextSibling;else{var d=b.nextSibling;a.removeChild(b);b=d}else 1==b.nodeType&&c.removeWhite(b),b=b.nextSibling;return a}};9==a.nodeType&&(a=a.documentElement);var d=c.toJson(c.toObj(c.removeWhite(a)),-1<a.nodeName.indexOf(":")?a.nodeName.split(":").pop():a.nodeName,"\t"),d="{\n"+b+(b?d.replace(/\t/g,b):d.replace(/\t|\n/g,""))+"\n}";return JSON.parse(d)};
XML.XTree.prototype.getJson=function(a){if(a=this.parseXml(a))return this.toJson(a,"\t")};var SOS=function(a){if(!(this instanceof SOS))throw Error("SOS "+SOS.Const.ErrorText.SOS_VIA_NEW);this.config=this.sensorDescFormatter=this.foiFormatter=this.obsFormatter=this.capsFormatter=this.events=this.scope=this.capabilitiesPromise=this.url=null;this.initialize(a)};SOS.bindingType={XML:"xml",JSON:"json"};SOS.offeringType={SOS_1:"sos_1",SOS_2:"sos_2"};SOS.Const={};
SOS.Const.ErrorText={SOS_VIA_NEW:" must be constructed via new",SOS_URL_MISSING:"Error requiere URL del servicio",SOS_CAPABILITIES_ERROR:"Error en la solicitud del capabilities",SOS_SENSOR_DESCRIPTION_ERROR:"Error en la solicitud de la descripci\u00f3n",SOS_FEATURE_OF_INTEREST_ERROR:"Error en la solicitud de features of interest",SOS_OBSERVATION_ERROR:"Error en la solicitud de observaciones",XML:{UNKNOWN_PARAM:"Error par\u00e1metro desconocido",WRONG_PARAM:"Error par\u00e1metro incorrecto",EMPTY_PARAM:"Error par\u00e1metro valor vac\u00edo"},
FOI:{SOS_FOI_GET_BY_POINT_SRS_MISSING:"Error requiere SRS",SOS_FOI_GET_BY_POINT_COORDS_MISSING:"Error requiere array con coordenadas",SOS_FOI_GET_BY_POINT_RADIUS_MISSING:"Error requiere radio en unidad de medida del mapa"}};
SOS.Const.Events={SOS_CAPABILITIES_AVAILABLE:"sosCapabilitiesAvailable",SOS_OFFERINGS_CAPABILITIES_AVAILABLE:"sosOffsCapabilitiesAvailable",SOS_SENSOR_DESCRIPTION_AVAILABLE:"sosSensorDescriptionAvailable",SOS_FEATURE_OF_INTEREST_AVAILABLE:"sosFeatureOfInterestAvailable",SOS_FEATURES_OF_INTEREST_AVAILABLE:"sosFeaturesOfInterestAvailable",SOS_OBSERVATION_AVAILABLE:"sosObservationAvailable",SOS_LATEST_OBSERVATION_AVAILABLE:"sosLatestObservationAvailable",SOS_OFFERING_OBSERVATION_AVAILABLE:"sosOfferingObsAvailable",
SOS_OFFERING_RESULT_AVAILABLE:"sosOfferingResultAvailable",SOS_OBSERVATION_BY_ID_AVAILABLE:"sosObservationByIdAvailable"};SOS.prototype.getResponseFormatType=function(a){switch(this.bindingType){case "xml":return"text/xml";case "json":return"application/json"}};SOS.prototype.getResponseFormat=function(){switch(this.bindingType){case "xml":return'text/xml;subtype="om/1.0.0"';case "json":return"application/json;charset=UTF-8"}};
SOS.prototype.initialize=function(a){this.url=null;a.bindingType?this.bindingType=a.bindingType:(this.bindingType=this.bindingType.XML,console.log("SOS bindingType missing."));SOS.Proxy.init();this.url=null;this.config={version:"2.0.0",async:!0,observation:{responseFormatType:this.getResponseFormatType(),responseFormat:this.getResponseFormat(),resultModel:"om:Measurement"},post:{setUrlFromCapabilities:!0,constraint:"Content-Type",responseFormatType:this.getResponseFormatType(!0),url:null}};this.availableOfferings=
[];this.events=new SOS.Events;SOS.Utils.extend(this,a);this.obsFormatter=a.entity&&a.entity instanceof SOS.entity.Observation?a.entity:new SOS.entity.Observation({sos:this,defaultSource:this.bindingType});this.foiFormatter=a.entity&&a.entity instanceof SOS.entity.FeatureOfInterest?a.entity:new SOS.entity.FeatureOfInterest({sos:this,defaultSource:this.bindingType});this.sensorDescFormatter=a.entity&&a.entity instanceof SOS.entity.DescribeSensor?a.entity:new SOS.entity.DescribeSensor({sos:this,defaultSource:this.bindingType});
this.capsFormatter=a.entity&&a.entity instanceof SOS.entity.Capabilities?a.entity:new SOS.entity.Capabilities({sos:this,defaultSource:this.bindingType});this.url&&(this.config.post.url=this.url)};SOS.prototype.copyMandatoryObjectProperties=function(a){"object"===typeof a&&(a.config=this.config,a.url=this.url);return a};
SOS.prototype.registerUserCallback=function(a){SOS.Utils.isValidObject(a)&&"string"===typeof a.event&&"function"===typeof a.callback&&(SOS.Utils.isValidObject(a.scope)||(a.scope=this),this.events.register(a.event,a.callback))};SOS.prototype.unregisterUserCallback=function(a){SOS.Utils.isValidObject(a)&&"string"===typeof a.event&&"function"===typeof a.callback&&(SOS.Utils.isValidObject(a.scope)||(a.scope=this),this.events.unregister(a.event,a.callback))};
SOS.prototype.getCapabilities=function(a){var b=this,c={scope:b,callback:a};return new SOS.Promise(function(a,e){b.capsFormatter.getCapabilities(c).then(function(b){a(b)})})};
SOS.prototype.getCapabilitiesOfferings=function(a){var b=this;SOS.OffsCapabilities=SOS.OffsCapabilities||{};if(SOS.OffsCapabilities[b.url]||b.offsCapabilitiesPromise instanceof SOS.Promise)return b.offsCapabilitiesPromise instanceof SOS.Promise?b.offsCapabilitiesPromise:new SOS.Promise(function(a,d){a(SOS.OffsCapabilities[b.url])});b.offsCapabilitiesPromise=new SOS.Promise(function(c,d){a&&b.registerUserCallback({event:SOS.Const.Events.SOS_OFFERINGS_CAPABILITIES_AVAILABLE,callback:a});SOS.Request.POST({url:b.url,
headers:{"Content-Type":b.capsFormatter.getContentType()},data:'<?xml version="1.0" encoding="UTF-8"?> <sos:GetCapabilities xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:sos="http://www.opengis.net/sos/2.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:swe="http://www.opengis.net/swe/2.0" service="SOS" xsi:schemaLocation="http://www.opengis.net/sos/2.0 http://schemas.opengis.net/sos/2.0/sosGetCapabilities.xsd"> <ows:AcceptVersions> <ows:Version>2.0.0</ows:Version> </ows:AcceptVersions> <ows:Sections> <ows:Section>Contents</ows:Section> </ows:Sections> </sos:GetCapabilities>',
scope:b,async:b.async,failure:function(a){d("Error getOfferingsCapabilities - "+b.url)},success:function(a){a&&a.responseText&&(0<a.responseText.indexOf("ExceptionText")?d("Error getCapabilities"):(a=(new SOS.source.XML).read(a.responseText),a.Capabilities&&(a=a.Capabilities),SOS.OffsCapabilities[b.url]=a,b.events.triggerEvent(SOS.Const.Events.SOS_OFFERINGS_CAPABILITIES_AVAILABLE),c(SOS.OffsCapabilities[b.url]),b.offsCapabilitiesPromise=null))}})});return b.offsCapabilitiesPromise};
SOS.prototype.haveValidCapabilitiesObject=function(){return SOS.Utils.isValidObject(this.capsFormatter.data)};SOS.prototype.setObservationResponseFormatFromTypeSuggestion=function(a){if(this.haveValidCapabilitiesObject()&&SOS.Utils.isValidObject(this.capsFormatter.data)){var b=this.capsFormatter.getOperationParameterValues("GetObservation","responseFormat");if(b)for(var c=0;c<b.length;c++)if(0<=b[c].indexOf(a)){this.config.observation.responseFormat=b[c];break}}};
SOS.prototype.getOfferingList=function(a){var b=this;a=a||SOS.offeringType.SOS_2;return new SOS.Promise(function(c,d){b.getCapabilitiesOfferings().then(function(){switch(a){case "sos_1":c(b.getSimpleOfferings());break;case "sos_2":c(b.getOfferings())}})})};
SOS.prototype._bindOfferings=function(){var a=this;SOS.OffsCapabilities=SOS.OffsCapabilities||{};var b=SOS.OffsCapabilities[a.url];if(b){var c={};b&&b.contents.contents&&(b.contents=b.contents.contents.offering);var d=function(a){return a.observedArea||a.observedArea&&a.observedArea.envelope?{crs:a.observedArea.envelope["@srsName"].split("/").pop(),lowerCorner:a.observedArea.envelope.lowerCorner.split(" "),upperCorner:a.observedArea.envelope.upperCorner.split(" ")}:{}},e=function(a){var b=[],c;for(c in a)"relatedFeature"==
c&&a[c].featureRelationship&&b.push(a[c].featureRelationship.target["@href"]);return b},g=function(b){for(var g=0;g<b.length;g++){var f=b[g].observationOffering||b[g];f&&(a.availableOfferings.push(new SOS.Offering({sos:a,bindingType:SOS.bindingType.JSON,identifier:f.identifier,name:f.name&&f.name["#text"]||"",featureOfInterestType:f.featureOfInterestType,featureOfInterestIds:e(f),observedProperties:f.observableProperty,observationType:f.observationType,observedArea:d(f),phenomenonTime:f.phenomenonTime,
procedures:f.procedure,procedureDescriptionFormat:f.procedureDescriptionFormat,responseFormat:f.responseFormat,resultTime:f.resultTime})),c[f.identifier]={featureOfInterestIds:e(f),name:f.name&&f.name["#text"],observedProperties:f.observableProperty,procedures:f.procedure instanceof Array?f.procedure:[f.procedure],responseFormats:f.responseFormat,responseModes:f.responseFormat,resultModels:[],time:{timePeriod:{beginPosition:f.resultTime&&f.resultTime.timePeriod?f.resultTime.timePeriod.beginPosition:
"",endPosition:f.resultTime&&f.resultTime.timePeriod?f.resultTime.timePeriod.endPosition:""}}},c[f.identifier].bounds=a.availableOfferings[g]&&a.availableOfferings[g].observedArea?{crs:a.availableOfferings[g].observedArea&&a.availableOfferings[g].observedArea.crs,bottom:a.availableOfferings[g].observedArea.lowerCorner&&a.availableOfferings[g].observedArea.lowerCorner.split(" ")[0],left:a.availableOfferings[g].observedArea.lowerCorner&&a.availableOfferings[g].observedArea.lowerCorner.split(" ")[1],
right:a.availableOfferings[g].observedArea.upperCorner&&a.availableOfferings[g].observedArea.upperCorner.split(" ")[0],top:a.availableOfferings[g].observedArea.upperCorner&&a.availableOfferings[g].observedArea.upperCorner.split(" ")[1]}:{})}},f=function(b){for(var g in b){var f=b[g];scope.availableOfferings.push(new SOS.Offering({sos:a,bindingType:SOS.bindingType.JSON,identifier:f.identifier,name:f.name&&f.name["#text"]||"",featureOfInterestType:f.featureOfInterestType,featureOfInterestIds:e(f),observedProperties:f.observableProperty,
observationType:f.observationType,observedArea:d(f),phenomenonTime:f.phenomenonTime,procedures:f.procedure,procedureDescriptionFormat:f.procedureDescriptionFormat,responseFormat:f.responseFormat,resultTime:f.resultTime}));c[f.identifier]={featureOfInterestIds:e(f),name:f.name&&f.name["#text"],observedProperties:f.observableProperty,procedures:f.procedure instanceof Array?f.procedure:[f.procedure],responseFormats:f.responseFormat,responseModes:f.responseFormat,resultModels:[],time:{timePeriod:{beginPosition:f.resultTime&&
f.resultTime.timePeriod?f.resultTime.timePeriod.beginPosition:"",endPosition:f.resultTime&&f.resultTime.timePeriod?f.resultTime.timePeriod.endPosition:""}}};c[f.identifier].bounds=a.availableOfferings[i]&&a.availableOfferings[i].observedArea?{crs:a.availableOfferings[i].observedArea&&a.availableOfferings[i].observedArea.crs,bottom:a.availableOfferings[i].observedArea.lowerCorner&&a.availableOfferings[i].observedArea.lowerCorner.split(" ")[0],left:a.availableOfferings[i].observedArea.lowerCorner&&
a.availableOfferings[i].observedArea.lowerCorner.split(" ")[1],right:a.availableOfferings[i].observedArea.upperCorner&&a.availableOfferings[i].observedArea.upperCorner.split(" ")[0],top:a.availableOfferings[i].observedArea.upperCorner&&a.availableOfferings[i].observedArea.upperCorner.split(" ")[1]}:{}}};b.contents instanceof Array?g(b.contents):f(b.contents);c&&(b.contents.offeringList=c)}};
SOS.prototype._getOfferings=function(a){var b=[];SOS.OffsCapabilities=SOS.OffsCapabilities||{};var c=SOS.OffsCapabilities[this.url];if(c)c&&!c.contents.offeringList?(this._bindOfferings(this),b=a?this.availableOfferings:c.contents.offeringList):b=!a&&c?c.contents.offeringList:c?this.availableOfferings:[];else return this.getOfferingList(SOS.offeringType.SOS_2);return new SOS.Promise(function(a,c){a(b)})};SOS.prototype.getSimpleOfferings=function(){return this._getOfferings(!1)};
SOS.prototype.getOfferings=function(){return this._getOfferings(!0)};SOS.prototype.getOfferingIds=function(){var a=this,b=[];return new SOS.Promise(function(c,d){a.getOfferingList(SOS.offeringType.SOS_2).then(function(a){if(a instanceof Array)for(var d=0;d<a.length;d++){var f=a[d];f.identifier&&b.push(f.identifier)}else for(d in a)f=a[d],b.push(f);c(b)})})};
SOS.prototype.getOfferingNames=function(){var a=this,b=[];return new SOS.Promise(function(c,d){a.getOfferingList(SOS.offeringType.SOS_2).then(function(a){for(var d in a)b.push(a[d].name);c(b)})})};
SOS.prototype.getOffering=function(a){var b=this,c;return new SOS.Promise(function(d,e){if(b.availableOfferings)for(var g=0;g<b.availableOfferings.length;g++){if(b.availableOfferings[g].identifier.toLowerCase()==a.toLowerCase()){c=b.availableOfferings[g];break}}else b.getOfferingList(SOS.offeringType.SOS_2).then(function(c){b.getOffering(a)});d(c)})};
SOS.prototype.getOfferingByName=function(a){var b=this;return new SOS.Promise(function(c,d){if(b.availableOfferings)for(var e=0;e<b.availableOfferings.length;e++)b.availableOfferings[e].name.toLowerCase()==a.toLowerCase()&&c(b.availableOfferings[e]);else b.getOfferingList(SOS.offeringType.SOS_2).then(function(b){if(b)for(var d in b)d.name.toLowerCase()==a.toLowerCase()&&c(d)});c(void 0)})};
SOS.prototype.getOfferingsForProcedureId=function(a){var b=this,c=[];return new SOS.Promise(function(d,e){b.getOfferingIds().then(function(e){for(var f=0;f<e.length;f++)for(var h=b.getOffering(e[f]),k=h.getProcedureIds(),l=0;l<k.length;l++)if(k[l]==a){c.push(h);break}d(c)})})};
SOS.prototype.getOfferingsForFeatureOfInterestId=function(a){var b=this,c=[];return new SOS.Promise(function(d,e){b.getOfferingList(SOS.offeringType.SOS_2).then(function(e){if(e instanceof Array)for(var f=0;f<e.length;f++){var h=e[f];h.featureOfInterestIds&&h.featureOfInterestIds instanceof Array&&-1<h.featureOfInterestIds.indexOf(a)&&b.getOffering(h.identifier).then(function(a){c.push(a)})}else for(f in e)h=e[f],h.featureOfInterestIds&&h.featureOfInterestIds instanceof Array&&-1<h.featureOfInterestIds.indexOf(a)&&
b.getOffering(f).then(function(a){c.push(a)});d(c)})})};SOS.prototype.getLatestObservationsForFeatureOfInterestId=function(a){var b=this;b.foiId=a;b.getOfferingsForFeatureOfInterestId(a).then(function(a){for(var d=0,e=a.length;d<e;d++)b.getLatestObservationsForOffering(a[d])})};SOS.prototype.getLatestObservationsForOffering=function(a){a={offering:a.id,observedProperties:a.observedProperties};this.foiId&&(a.foi={featuresOfInterest:this.foiId});this.obsFormatter.getObservationLatest(a)};
SOS.prototype.getObservationsForOffering=function(a,b,c){a={offering:a.id,observedProperties:a.observedProperties};this.foiId&&(a.foi={featuresOfInterest:this.foiId});this.obsFormatter.getObservationFirst(a)};SOS.prototype.haveValidObservationsObject=function(){return SOS.Utils.isValidObject(this.SOSObservations)};
SOS.prototype.getCountOfObservations=function(){var a=0;this.haveValidObservationsObject()&&SOS.Utils.isValidObject(this.SOSObservations.measurements)&&(a=this.SOSObservations.measurements.length);return a};SOS.prototype.getObservationRecord=function(a){var b={};this.haveValidObservationsObject()&&(b=this.SOSObservations.measurements[a],b=this.addPropertiesToObservationRecord(b));return b};
SOS.prototype.getFilteredObservationRecord=function(a,b){var c;if(this.haveValidObservationsObject()){var d=this.SOSObservations.measurements[a];SOS.Utils.isValidObject(b)?SOS.Utils.isValidObject(b.foiId)?(d=this.getFeatureOfInterestFromObservationRecord(d))&&d.attributes.id==b.foiId&&(c=this.SOSObservations.measurements[a]):SOS.Utils.isValidObject(b.observedProperty)&&d.observedProperty==b.observedProperty&&(c=this.SOSObservations.measurements[a]):c=this.SOSObservations.measurements[a];c=this.addPropertiesToObservationRecord(c)}return c};
SOS.prototype.addPropertiesToObservationRecord=function(a){SOS.Utils.isValidObject(a)&&(a.time=a.samplingTime.timeInstant.timePosition,a.observedPropertyTitle=SOS.Utils.toTitleCase(SOS.Utils.toDisplayName(SOS.Utils.fqnToName(a.observedProperty))),a.uomTitle=SOS.Utils.toDisplayUom(a.result.uom));return a};
SOS.prototype.observationRecordHasValidFeatureOfInterest=function(a,b){b=b||{foisIndex:0,featuresIndex:0};return SOS.Utils.isValidObject(a.fois)&&SOS.Utils.isValidObject(a.fois[b.foisIndex])&&SOS.Utils.isValidObject(a.fois[b.foisIndex].features)&&SOS.Utils.isValidObject(a.fois[b.foisIndex].features[b.featuresIndex])};SOS.prototype.getFeatureOfInterestFromObservationRecord=function(a,b){b=b||{foisIndex:0,featuresIndex:0};return a.fois[b.foisIndex].features[b.featuresIndex]};
SOS.prototype.getFeatureOfInterest=function(a){this.foiFormatter.getFeatureOfInterest({featureOfInterest:a})};SOS.prototype.describeSensor=function(a){this.sensorDescFormatter.getDescribeSensor({idProcedure:a})};SOS=SOS||{};
SOS.Utils={Geom:{createBBox:function(a,b){for(var c=-.25*Math.PI,d,e,g=[],f=[],h=0;4>h;++h)d=c+2*h*Math.PI/4,e=a[0]+b*Math.cos(d),d=a[1]+b*Math.sin(d),g.push(e),f.push(d);return{lowerCorner:[Math.min.apply(null,g),Math.min.apply(null,f)],upperCorner:[Math.max.apply(null,g),Math.max.apply(null,f)]}}},Converter:{Types:{INT:"int",FLOAT:"float"},DataTypeConverter:function(){this.createConverter=function(a){var b;switch(a){case SOS.Utils.Converter.Types.FLOAT:b=new SOS.Utils.Converter.CFloat;break;case SOS.Utils.Converter.Types.INT:b=
new SOS.Utils.Converter.CInt}b.type=a;b.convert||(b.convert=function(){throw Error("Missing convert function!!");});return b}},CFloat:function(){this.is=function(a){return null!=a.toString().match(SOS.Utils.regExes.isFloatNumber)};this.convert=function(a){return parseFloat(a)}},CInt:function(){this.is=function(a){return null!=a.toString().match(SOS.Utils.regExes.isIntNumber)};this.convert=function(a){return parseInt(a)}}},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,
isIntNumber:/^(\d+)/,isFloatNumber:/-?\d+[\.\,]\d+/},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(null!=d&&"function"!=typeof d){if("object"==typeof d&&d.constructor==Array){for(var e=[],g,f=0,h=d.length;f<h;f++)g=d[f],e.push(encodeURIComponent(null===g||void 0===g?"":g));d=e.join(",")}else d=encodeURIComponent(d);b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},uomDisplayTitles:{Cel:"&deg;C",deg:"&deg;","m/s":"m s<sup>-1</sup>"},nonPrintingCharacterLabels:{" ":"(space)",
"\t":"(tab)","\n":"(newline)","\r\n":"(carriage return/newline)","\r":"(carriage return)"},fullyQualifiedNames:{url:{test:/^\s*http/i,re:/^.*\/(.+)$/,s:"$1"},urn:{test:/^\s*urn/i,re:/^.*:/,s:""}},indexOf:function(a,b){if("function"==typeof a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;c<d;c++)if(a[c]==b)return c;return-1},isValidObject:function(a){return"undefined"!==typeof a&&null!==a},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},isNumber:function(a){return!isNaN(parseFloat(a))&&
isFinite(a)},getUniqueList:function(a){for(var b=[],c=0,d=a.length;c<d;c++)-1===this.indexOf(b,a[c])&&b.push(a[c]);return b},toTitleCase:function(a){var b=a;if("string"==typeof a){a=a.split(/ /);for(var b=0,c=a.length;b<c;b++)a[b]=a[b].replace(/^(.)/,function(a,b,c,d){return b.toUpperCase()});b=a.join(" ")}else if(this.isArray(a))for(var b=[],d=0,c=a.length;d<c;d++)b.push(this.toTitleCase(a[d]));return b},toDisplayName:function(a){var b=a;if("string"==typeof a)b=a.replace(/_/g," ");else if(this.isArray(a))for(var b=
[],c=0,d=a.length;c<d;c++)b.push(this.toDisplayName(a[c]));return b},_fqnToName:function(a,b,c){return a.replace(b,c)},_lookupFqnFromName:function(a,b,c,d){for(var e=a,g=0,f=b.length;g<f;g++)if(this._fqnToName(b[g],c,d)===a){e=b[g];break}return e},fqnToName:function(a,b){var c=a,d=this.fullyQualifiedNames;if(this.isValidObject(d))if("string"==typeof a)c=b&&b.hasOwnProperty("re")&&b.hasOwnProperty("s")?this._fqnToName(a,b.re,b.s):d.url.test.test(a)?this._fqnToName(a,d.url.re,d.url.s):this._fqnToName(a,
d.urn.re,d.urn.s);else if(this.isArray(a))for(var c=[],d=0,e=a.length;d<e;d++)c.push(this.fqnToName(a[d],b));return c},lookupFqnFromName:function(a,b,c){var d=a,e=this.fullyQualifiedNames;if(this.isValidObject(e))if("string"==typeof a)d=c&&c.hasOwnProperty("re")&&c.hasOwnProperty("s")?this._lookupFqnFromName(a,b,c.re,c.s):e.url.test.test(b[0])?this._lookupFqnFromName(a,b,e.url.re,e.url.s):this._lookupFqnFromName(a,b,e.urn.re,e.urn.s);else if(this.isArray(a))for(var d=[],e=0,g=a.length;e<g;e++)d.push(this.lookupFqnFromName(a[e],
b,c));return d},urlToName:function(a){return this.fqnToName(a,this.fullyQualifiedNames.url)},lookupUrlFromName:function(a,b){return this.lookupFqnFromName(a,b,this.fullyQualifiedNames.url)},urnToName:function(a){return this.fqnToName(a,this.fullyQualifiedNames.urn)},lookupUrnFromName:function(a,b){return this.lookupFqnFromName(a,b,this.fullyQualifiedNames.urn)},toDisplayUom:function(a){var b=a;if(this.isValidObject(this.uomDisplayTitles))if("string"==typeof a)this.uomDisplayTitles[a]&&(b=this.uomDisplayTitles[a]);
else if(this.isArray(a))for(var b=[],c=0,d=a.length;c<d;c++)b.push(this.toDisplayUom(a[c]));return b},nonPrintingCharacterToLabel:function(a){var b=a;if(this.isValidObject(this.nonPrintingCharacterLabels))if("string"==typeof a)this.nonPrintingCharacterLabels[a]&&(b=this.nonPrintingCharacterLabels[a]);else if(this.isArray(a))for(var b=[],c=0,d=a.length;c<d;c++)b.push(this.nonPrintingCharacterToLabel(a[c]));return b},newlineToBr:function(a){var b=a;if("string"==typeof a)b=a.replace(/(\r\n|\n|\r)/g,
"<br/>");else if(this.isArray(a))for(var b=[],c=0,d=a.length;c<d;c++)b.push(this.newlineToBr(a[c]));return b},applyTemplate:function(a,b,c){c=c||"gi";var d=b;if(this.isArray(a))for(var d=[],e=0,g=a.length;e<g;e++)d.push(this.applyTemplate(a[e],b,c));else if(d)for(e in a)d=d.replace(new RegExp("\\[%\\s*"+e+"\\s*%\\]",c),a[e]);return d},isoToDateObject:function(a){var b=a;if("string"==typeof a){var c=a.split(/T/);2>c.length&&(c[1]="00:00:00.000Z");b=c[0].split(/-/);c[1]=c[1].replace(/Z$/,"");var d=
/([-+])(\d{2})[:]?(\d{2})?/.exec(c[1]),e=0;d&&(2<d.length&&(e+=60*parseInt(d[2],10)),3<d.length&&(e+=parseInt(d[3],10)),1<d.length&&"+"===d[1]&&(e*=-1));c[1]=c[1].replace(/[-+].+$/,"");c=c[1].split(/:/);d=c[2].replace(/^\d+\./,"");c[2]=c[2].replace(/\.\d+$/,"");b=new Date(Date.UTC(parseInt(b[0],10),parseInt(b[1]-1,10),parseInt(b[2],10),parseInt(c[0],10),parseInt(c[1],10),parseInt(c[2],10),parseInt(d,10)));isNaN(b)?b=a:0!=e&&b.setTime(b.getTime()+6E4*e)}else if(this.isArray(a))for(b=[],e=0,c=a.length;e<
c;e++)b.push(this.isoToDateObject(a[e]));return b},isoToJsTimestamp:function(a){var b=a;if("string"==typeof a)b=this.isoToDateObject(a).getTime();else if(this.isArray(a))for(var b=[],c=0,d=a.length;c<d;c++)b.push(this.isoToJsTimestamp(a[c]));return b},jsTimestampToIso:function(a){var b=a;if("string"==typeof a||"number"==typeof a)a=new Date(a),isNaN(a)||(b=a.toISOString());else if(this.isArray(a))for(var b=[],c=0,d=a.length;c<d;c++)b.push(this.jsTimestampToIso(a[c]));return b},isoToTimeInterval:function(a,
b){var c={start:null,end:null};c.start=this.isoToDateObject(a);c.end=this.isoToDateObject(b);return c},adjustTimeInterval:function(a,b,c){a.start.setTime(a.start.getTime()+b);a.end.setTime(a.end.getTime()+c);return a},parseRelativeTime:function(a){var b={start:null,end:null},c=new Date,d=c.getTime(),e=0,g=0,f=0;b.start=new Date(d);b.end=new Date(d);a=a.replace(/to|current/i,"this");a=a.replace(/yester|previous/i,"last");/hour$/i.test(a)&&(e=36E5,g=d%e);/day$/i.test(a)&&(e=864E5,g=d%e);/week$/i.test(a)&&
(f=864E5,e=6048E5,g=c.getUTCDay()*f+d%f);/month$/i.test(a)&&(f=864E5,e=26784E5,g=(c.getUTCDate()-1)*f+d%f);/year$/i.test(a)&&(f=864E5,e=316224E5,g=(c.getUTCDayOfYear()-1)*f+d%f);/^this/i.test(a)&&this.adjustTimeInterval(b,-g,-g+e-1);/^last/i.test(a)&&this.adjustTimeInterval(b,-g-e,-g-1);/^rolling/i.test(a)&&this.adjustTimeInterval(b,-e,-1);return b},extractColumn:function(a,b){var c=[];if(this.isArray(a))for(var d=0,e=a.length;d<e;d++)c.push(a[d][b]);return c},sum:function(a){for(var b=0,c=0,d=a.length;c<
d;c++)b+=parseFloat(a[c]);return b},computeStats:function(a){var b={N:0,sum:0,min:0,max:0,mean:0,median:0,q1:0,q3:0,variance:0,sd:0};if(this.isArray(a)&&1<a.length){b.N=a.length;b.sum=this.sum(a);b.mean=b.sum/b.N;b.min=Math.min.apply(null,a);b.max=Math.max.apply(null,a);var c=a.slice(0);c.sort(function(a,b){return a-b});var d=Math.floor(b.N/2);b.median=0==b.N%2?this.sum(c.slice(d,d+2))/2:c[d+1];d=Math.floor(b.N/4);b.q1=0==b.N%2?this.sum(c.slice(d,d+2))/2:c[d+1];d*=3;b.q3=0==b.N%2?this.sum(c.slice(d,
d+2))/2:c[d+1];for(var d=c=0,e=a.length;d<e;d++)c+=Math.pow(a[d]-b.mean,2);b.variance=c/(b.N-1);b.sd=Math.sqrt(b.variance)}return b},computeHistogram:function(a){var b={min:0,max:0,lower:0,upper:0,nBins:0,binWidth:0,data:[]};if(this.isArray(a)&&1<a.length){var c=0;a=a.slice(0);a.sort(function(a,b){return a-b});b.min=Math.min.apply(null,a);b.max=Math.max.apply(null,a);b.lower=Math.floor(b.min);b.upper=Math.ceil(b.max);b.nBins=10;if(0<b.upper-b.lower){b.binWidth=Math.pow(10,Math.round(Math.log(b.upper-
b.lower)/Math.log(10)))/b.nBins;for(var d=b.lower;d<b.upper;d+=b.binWidth){for(var e=[d,0],g=a.length;c<g;c++)if(a[c]<d+b.binWidth)e[1]++;else break;b.data.push(e)}}}return b},mergeSeries:function(a,b){b=b||{n:0,m:1,missing:null};var c=[],d=[],e=[];if(this.isArray(a))if(1<a.length){for(var g=0,f=a.length;g<f;g++)c=c.concat(this.extractColumn(a[g],b.n)),d.push(0);c.sort(function(a,b){return a-b});c=this.getUniqueList(c);g=0;for(f=c.length;g<f;g++){var h=[];h[0]=c[g];for(var k=0,l=a.length;k<l;k++){h[k+
1]=b.missing;for(var m=d[k],n=a[k].length;m<n;m++)if(a[k][m][b.n]==c[g]){h[k+1]=a[k][m][b.m];d[k]=m;break}}e.push(h)}}else e=a[0];return e},removeMissingDataRows:function(a,b){b=b||{missing:null};var c=[];if(this.isArray(a)&&this.isArray(a[0]))for(var d=0,e=a.length;d<e;d++){for(var g=!1,f=0,h=a[d].length;f<h;f++)if(a[d][f]==b.missing){g=!0;break}0==g&&c.push(a[d])}return c},reorderColumns:function(a,b){var c=[];if(this.isArray(a)&&this.isArray(a[0])&&this.isArray(b)&&Math.max.apply(null,b)<a[0].length&&
0<=Math.min.apply(null,b))for(var d=0,e=a.length;d<e;d++){for(var g=[],f=0,h=b.length;f<h;f++)g.push(a[d][b[f]]);c.push(g)}return c},removeColumns:function(a,b){var c=[],d=[];if(this.isArray(a)&&this.isArray(a[0])&&this.isArray(b)&&Math.max.apply(null,b)<a[0].length&&0<=Math.min.apply(null,b)){for(var c=0,e=a[0].length;c<e;c++){for(var g=!1,f=0,h=b.length;f<h;f++)if(c==b[f]){g=!0;break}0==g&&d.push(c)}c=this.reorderColumns(a,d)}return c},extend:function(a,b){a=a||{};if(b){for(var c in b){var d=b[c];
void 0!==d&&(a[c]=d)}!("function"==typeof window.Event&&b instanceof window.Event)&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&(a.toString=b.toString)}return a},applyDefaults:function(a,b){a=a||{};var c="function"==typeof window.Event&&b instanceof window.Event,d;for(d in b)if(void 0===a[d]||!c&&b.hasOwnProperty&&b.hasOwnProperty(d)&&!a.hasOwnProperty(d))a[d]=b[d];!c&&b&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&!a.hasOwnProperty("toString")&&(a.toString=b.toString);return a},urlAppend:function(a,
b){var c=a;if(b)var d=(a+" ").split(/[?&]/),c=c+(" "===d.pop()?b:d.length?"&"+b:"?"+b);return c}};SOS.inherit=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;var d,e,c=2;for(d=arguments.length;c<d;c++)e=arguments[c],"function"===typeof e&&(e=e.prototype),SOS.Utils.extend(a.prototype,e)};SOS=SOS||{};SOS.Const.PROXY_HOST="Proxy/proxy.ashx?";(function(){var a=window.location,b=a.pathname.substring(0,a.pathname.lastIndexOf("/")+1);SOS.sosLocation=a.href.substring(0,a.href.length-((a.pathname+a.search+a.hash).length-b.length))})();
SOS.Proxy={use:!1,url:SOS.sosLocation+SOS.Const.PROXY_HOST,init:function(a){if(SOS.Utils.isValidObject(a))for(var b in a)this[b]=a[b];this.use?this.enable():this.disable()},enable:function(a){if(SOS.Utils.isValidObject(a))for(var b in a)this[b]=a[b];this.url&&(SOS.ProxyHost=this.url);return this.url},disable:function(){SOS.ProxyHost=null}};SOS=SOS||{};SOS.Promise=function(a){function b(a){a&&"function"===typeof a.then?a.then(b,c):(e="resolved",g=a,f&&d(f))}function c(a){e="rejected";g=a;f&&d(f)}function d(a){if("pending"===e)f=a;else{var b;(b="resolved"===e?a.onResolved:a.onRejected)?(b=b(g),a.resolve(b)):"resolved"===e?a.resolve(g):a.reject(g)}}var e="pending",g,f=null;this.then=function(a,b){return new SOS.Promise(function(c,e){d({onResolved:a,onRejected:b,resolve:c,reject:e})})};a(b,c)};SOS=SOS||{};SOS.Events=function(){this.listeners={}};SOS.Events.prototype.enable=function(){var a=this;a.listeners||(a.listeners={});a.triggerEvent=function(b,c){SOS.Events.prototype.triggerEvent.call(a,b,c);console.log(b)};a.register=function(b,c){SOS.Events.prototype.register.call(a,b,c)};a.unregister=function(b,c){SOS.Events.prototype.unregister.call(a,b,c)}};
SOS.Events.prototype.triggerEvent=function(a,b){if(this.listeners[a])for(var c=this.listeners[a].reverse(),d=0;d<c.length;d++)b?c[d].apply(window,b):c[d].call(window)};SOS.Events.prototype.register=function(a,b){this.enable.call(this,a);var c=this.listeners[a]||[];if(b instanceof Function){for(var d=!1,e=0;e<c.length;e++)c[e]===b&&(d=!0);!1===d&&c.push(b)}this.listeners[a]=c};
SOS.Events.prototype.unregister=function(a,b){if(this.listeners[a]&&0<this.listeners[a].length)if(b){for(var c=[],d=0;d<this.listeners[a].length;d++)b!=this.listeners[a][d]&&c.push(this.listeners[a][d]);this.listeners[a]=c}else this.listeners[a]=[]};SOS.Request={DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:SOS.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},events:new SOS.Events,_getXMLHttpRequest:function(){try{return new XMLHttpRequest}catch(a){console.log("XMLHttpRequest missing")}},createXMLHttpRequest:function(a){var b=this,c=SOS.Utils.extend(b.DEFAULT_CONFIG,{proxy:SOS.ProxyHost});a=SOS.Utils.applyDefaults(a,c);var d=b._getXMLHttpRequest();
if(d){c=SOS.Utils.urlAppend((SOS.ProxyHost||"")+a.url,SOS.Utils.getParameterString(a.params||{}));d.open(a.method,c,a.async,a.user,a.password);for(var e in a.headers)d.setRequestHeader(e,a.headers[e]);d.onreadystatechange=function(){if(d.readyState==d.DONE){a.callback.apply(a.scope,[d]);if(!d.status||200<=d.status&&300>d.status)if(b.events.triggerEvent("success",{}),a.success){var c;a:{if(d&&(c=/<ows:ExceptionText>([\s\S]*?)<\/ows:ExceptionText>/g.exec(d.responseText))){c=c[1];break a}c=null}null==
c?a.success.apply(a.scope,[d]):a.failure&&a.failure.apply(a.scope,[c])}d.status&&(200>d.status||300<=d.status)&&(b.events.triggerEvent("failure",{}),a.failure&&a.failure.apply(a.scope,[d]))}};!1===a.async?d.send(a.data):window.setTimeout(function(){0!==d.readyState&&d.send(a.data)},0)}},GET:function(a){a=SOS.Utils.extend(a,{method:"GET"});return this.createXMLHttpRequest(a)},POST:function(a){a=SOS.Utils.extend(a,{method:"POST"});return this.createXMLHttpRequest(a)}};SOS=SOS||{};SOS.Source=function(){};SOS.Source.prototype.reader={};SOS.Source.prototype.read=function(a){throw Error("Read not implemented.");};SOS.Source.prototype.write=function(a){throw Error("Write not implemented.");};SOS.source=SOS.source||{};SOS.source.XML=function(a){this.initialize(this)};SOS.inherit(SOS.source.XML,SOS.Source);SOS.source.XML.prototype.initialize=function(a){a.reader=new XML.XTree};SOS.source.XML.prototype.read=function(a){return this.reader.getJson(a)};
SOS.source.XML.prototype.write=function(a,b){for(var c in a){if(!(new RegExp("(\\b"+c+"\\b)","g")).test(b.join(",")))throw Error(SOS.Const.ErrorText.XML.UNKNOWN_PARAM+": "+c);if(!a[c]||a[c]&&0==a[c].toString().trim().length)throw Error(SOS.Const.ErrorText.XML.EMPTY_PARAM);}};SOS.source.JSON=function(a){};SOS.inherit(SOS.source.JSON,SOS.Source);SOS.source.JSON.prototype.write=function(a){return JSON.stringify(a)};SOS.source.JSON.prototype.read=function(a){return JSON.parse(a)};SOS.Offering=function(a){this.entityName="Offering";this.initialize(a)};
SOS.Offering.prototype.initialize=function(a){this.sos=a.sos||sos;this.observationData="";this.identifier=a.identifier||a.id||"";this.name=a.name||"";this.featureOfInterestIds=a.featureOfInterestIds instanceof Array&&a.featureOfInterestIds||a.featureOfInterestIds&&[a.featureOfInterestIds]||[];this.featureOfInterestType=a.featureOfInterestType instanceof Array&&a.featureOfInterestType||a.featureOfInterestType&&[a.featureOfInterestType]||[];this.observedProperties=a.observedProperties instanceof Array&&
a.observedProperties||a.observedProperties&&[a.observedProperties]||[];this.observationType=a.observationType instanceof Array&&a.observationType||a.observationType&&[a.observationType]||[];this.observedArea=a.observedArea&&a.observedArea.crs&&a.observedArea.lowerCorner&&a.observedArea.upperCorner?a.observedArea&&a.observedArea.crs+" - "+a.observedArea.lowerCorner+a.observedArea.upperCorner:{crs:"",lowerLeft:[],upperRight:[]};this.phenomenonTime=a.phenomenonTime instanceof Array&&a.phenomenonTime||
a.phenomenonTime&&[a.phenomenonTime]||[];this.procedures=a.procedures instanceof Array&&a.procedures||[a.procedures];this.procedureDescriptionFormat=a.procedureDescriptionFormat instanceof Array&&a.procedureDescriptionFormat||a.procedureDescriptionFormat&&[a.procedureDescriptionFormat]||[];this.responseFormat=a.responseFormat instanceof Array&&a.responseFormat||a.responseFormat&&[a.responseFormat]||[];this.resultTime=a.resultTime instanceof Array&&a.resultTime||a.resultTime&&[a.resultTime]||[]};
SOS.Offering.prototype.destroy=function(){};SOS.Offering.prototype.getFeatureOfInterestIds=function(){return SOS.Utils.getUniqueList(this.featureOfInterestIds)};SOS.Offering.prototype.getProcedureIds=function(){return SOS.Utils.getUniqueList(this.procedures)};SOS.Offering.prototype.getObservedPropertyIds=function(){return SOS.Utils.getUniqueList(this.observedProperties)};SOS.Offering.prototype.getObservedPropertyNames=function(){return SOS.Utils.fqnToName(SOS.Utils.getUniqueList(this.observedProperties))};
SOS.Offering.prototype.filterObservedProperties=function(a){SOS.Utils.isArray(a)||(a=[a]);var b=SOS.Utils.isValidObject(this.observedPropertiesOriginal)?this.observedPropertiesOriginal:this.observedProperties;a=SOS.Utils.lookupFqnFromName(a,b);SOS.Utils.isValidObject(this.observedPropertiesOriginal)||(this.observedPropertiesOriginal=this.observedProperties);this.observedProperties=a};
SOS.Offering.prototype.unfilterObservedProperties=function(){SOS.Utils.isValidObject(this.observedPropertiesOriginal)&&(this.observedProperties=this.observedPropertiesOriginal,delete this.observedPropertiesOriginal)};
SOS.Offering.prototype.getLatestObservations=function(a){0<arguments.length&&this.sos.registerUserCallback({event:SOS.Const.Events.SOS_OFFERING_OBSERVATION_AVAILABLE,callback:a});var b={offering:this.identifier||this.id,observedProperties:this.observedProperties};this.sos.foiId&&(b.foi={featuresOfInterest:this.sos.foiId});this.sos.obsFormatter.getObservationLatest(b,a,this)};
SOS.Offering.prototype.getObservations=function(a,b,c){2<arguments.length&&this.sos.registerUserCallback({event:SOS.Const.Events.SOS_OFFERING_OBSERVATION_AVAILABLE,callback:c});var d={offering:this.id||this.identifier,observedProperties:this.observedProperties,temporal:{start:a,end:b,operator:"During",on:"phenomenonTime",operand:"TimePeriod"}};this.sos.foiId&&(d.foi={featuresOfInterest:this.sos.foiId});this.sos.obsFormatter.getObservationByScope(d,c,SOS.Const.Events.SOS_OFFERING_OBSERVATION_AVAILABLE,
this)};SOS.Offering.prototype.getCountOfObservations=function(){var a=0;this.observationData&&SOS.Utils.isValidObject(this.observationData)&&(a=this.observationData instanceof Array?this.observationData.length:1);return a};SOS.Offering.prototype.getObservationRecord=function(a){var b={};this.observationData&&(b=this.observationData instanceof Array?this.observationData[a]:this.observationData);return b};
SOS.Offering.prototype.getFilteredObservationRecord=function(a,b){var c;if(this.observationData){var d=this.observationData[a];SOS.Utils.isValidObject(b)?SOS.Utils.isValidObject(b.foiId)?(d=_sos.getFeatureOfInterestFromObservationRecord(d))&&d.attributes.id==b.foiId&&(c=_sos.SOSObservations.measurements[a]):SOS.Utils.isValidObject(b.observedProperty)&&d.observedProperty==b.observedProperty&&(c=_sos.SOSObservations.measurements[a]):c=_sos.SOSObservations.measurements[a];c=_sos.addPropertiesToObservationRecord(c)}return c};
SOS.Offering.prototype.getResults=function(a,b,c){2<arguments.length&&this.sos.registerUserCallback({event:SOS.Const.Events.SOS_OFFERING_RESULT_AVAILABLE,callback:c});this.sos.obsFormatter.getObservationByScope({offering:this.id||this.identifier,observedProperties:this.observedProperties},c,SOS.Const.Events.SOS_OFFERING_OBSERVATION_AVAILABLE,this)};SOS=SOS||{};SOS.method=SOS.method||{};SOS.Method=function(){};SOS.inherit(SOS.Method,SOS.Source);SOS.method.GET=function(a){this.scope=a};SOS.inherit(SOS.method.GET,SOS.Method);SOS.method.GET.prototype.read=function(a){this.scope.data=this.scope.sources&&this.scope.sources[this.scope.defaultSource]?this.scope.sources[this.scope.defaultSource].read(a):this.scope.sources.xml.read(a)};
SOS.method.GET.prototype.write=function(a){return this.scope.sources&&this.scope.sources[this.scope.defaultSource]?this.scope.sources[this.scope.defaultSource].write(a):this.scope.sources.xml.write(a)};SOS=SOS||{};SOS.entity=SOS.entity||{};
SOS.Entity=function(a){var b=this;a=a||{};if(!(this instanceof SOS.Entity))throw Error("Error "+b.entityName+" "+SOS.Const.ErrorText.SOS_VIA_NEW);b.data=null;b.sources={};if(!a.sos&&!a.url)throw Error(SOS.Const.ErrorText.SOS_URL_MISSING);b.sos=a.sos||new SOS({url:a.url,bindingType:SOS.bindingType.XML,entity:b});b.defaultSource=a.defaultSource||a||"xml";b.postCfg=null;b.dcp=b.dcp||[];b.postUrl=b.postUrl||"";b.sources&&(b.sources.xml||(b.sources.xml=b.bindSourceXML()),b.sources.json||(b.sources.json=
b.bindSourceJSON()));b.get=new SOS.method.GET(b);b.capsOperation&&b.sos.registerUserCallback({event:SOS.Const.Events.SOS_CAPABILITIES_AVAILABLE,callback:function(){b.bindUrlConfig()}})};
SOS.Entity.prototype.bindUrlConfig=function(){var a=this,b=function(){a.postCfg=[];if(a.dcp)if(a.dcp instanceof Array)for(var b=0;b<a.dcp.length;b++)"post"==a.dcp[b].method.toLowerCase()&&a.postCfg.push({"@href":a.dcp[b].href,constraint:{allowedValues:{value:a.dcp[b].constraints["Content-Type"].allowedValues}}});else a.dcp&&a.dcp.hTTP&&(a.postCfg=a.dcp.hTTP.post);if(a.postCfg)if(b=a.postCfg,b instanceof Array)for(b=0;b<a.postCfg.length;b++){var c=a.postCfg[b]["@href"],g;for(g in a.postCfg[b].constraint.allowedValues){if(a.postCfg[b].constraint.allowedValues[g]instanceof
Array)for(var f=0;f<a.postCfg[b].constraint.allowedValues[g].length;f++)if(a.postCfg[b].constraint.allowedValues[g][f]==a.sos.config.post.responseFormatType)return c;if(a.postCfg[b].constraint.allowedValues[g]==a.sos.config.post.responseFormatType)return c}}else return b["@href"]},c=a.sos.capsFormatter.getOperation(a.capsOperation);c&&(a.dcp=c.dCP||c.dcp,a.postUrl=b())};
SOS.Entity.prototype.getPostUrl=function(){var a=this;return a.postUrl?new SOS.Promise(function(b,c){b(a.postUrl)}):new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(c){null==a.sos.capsFormatter.data&&(a.sos.capsFormatter.data=c);a.bindUrlConfig();b(a.postUrl)})})};SOS.Entity.prototype.getContentType=function(){if(this.sources&&this.sources[this.defaultSource])switch(this.defaultSource){case "json":return"application/json";case "xml":return"application/xml"}};
SOS.Entity.prototype.bindSourceXML=function(){throw Error("bindSourceXML not implemented.");};SOS.Entity.prototype.bindSourceJSON=function(){throw Error("bindSourceJSON not implemented.");};SOS.entity.Capabilities=function(a){this.entityName="Capabilities";SOS.Entity.apply(this,arguments);this.getCapabilities()};SOS.inherit(SOS.entity.Capabilities,SOS.Entity);
SOS.entity.Capabilities.prototype.getCapabilities=function(a){var b=this;a=a||{};if(b.sos&&!b.sos.url)throw Error(SOS.Const.ErrorText.SOS_URL_MISSING);SOS.Capabilities=SOS.Capabilities||{};if(SOS.Capabilities[b.sos.url]||b.sos.capabilitiesPromise instanceof SOS.Promise)return b.sos.capabilitiesPromise instanceof SOS.Promise?b.sos.capabilitiesPromise:new SOS.Promise(function(a,d){a(SOS.Capabilities[b.sos.url])});b.sos.capabilitiesPromise=new SOS.Promise(function(c,d){a.callback&&a.scope.registerUserCallback({event:SOS.Const.Events.SOS_CAPABILITIES_AVAILABLE,
callback:a.callback});SOS.Request.POST({url:b.sos.url,headers:{"Content-Type":b.getContentType()},data:b.get.write(),scope:b.sos,async:b.sos.async,failure:function(a){console.log(SOS.Const.ErrorText.SOS_CAPABILITIES_ERROR);console.log(a);d(SOS.Const.ErrorText.SOS_CAPABILITIES_ERROR+" :"+a)},success:function(a){a&&a.responseText&&(b.get.read(a.responseText),b.data&&(b.data.Capabilities&&(b.data=b.data.Capabilities),b.sos.SOSCapabilities=b.data,b.sos.setObservationResponseFormatFromTypeSuggestion(b.sos.config.observation.responseFormatType)),
SOS.Capabilities[b.sos.url]=b.data,b.sos.events.triggerEvent(SOS.Const.Events.SOS_CAPABILITIES_AVAILABLE),c(SOS.Capabilities[b.sos.url]),b.sos.capabilitiesPromise=null)}})});return b.sos.capabilitiesPromise};
SOS.entity.Capabilities.prototype.getOperation=function(a){if(SOS.Utils.isValidObject(SOS.Capabilities[this.sos.url])){var b=this.getOperationMetadata();if(b instanceof Array)for(var c=0;c<b.length;c++){if(b[c]["@name"].toLowerCase()==a.toLowerCase().replace(SOS.Utils.regExes.trimSpace,""))return b[c]}else if(b instanceof Object&&SOS.Utils.isValidObject(b))for(c in b)if(c.toLowerCase()==a.toLowerCase().replace(SOS.Utils.regExes.trimSpace,""))return b[c]}return null};
SOS.entity.Capabilities.prototype.getOperationParameters=function(a){a=this.getOperation(a);if(SOS.Utils.isValidObject(a))return a.parameter||a.parameters};
SOS.entity.Capabilities.prototype.getOperationParameterValues=function(a,b){var c=this.getOperationParameters(a);if(SOS.Utils.isValidObject(c))if(c instanceof Array)for(var d=0;d<c.length;d++){if(c[d]["@name"].toLowerCase()==b.toLowerCase().replace(SOS.Utils.regExes.trimSpace,""))return c[d].allowedValues?c[d].allowedValues.value||c[d].allowedValues:null}else if(c instanceof Object)for(d in c)if(d.toLowerCase()==b.toLowerCase().replace(SOS.Utils.regExes.trimSpace,""))return c[d].allowedValues?c[d].allowedValues.value||
c[d].allowedValues:c[d];return[]};SOS.entity.Capabilities.prototype.getOperationMetadata=function(){if(SOS.Capabilities[this.sos.url]){var a=SOS.Capabilities[this.sos.url];if(a.operationsMetadata)return a.operationsMetadata.operation;if(a.operationMetadata)return a.operationMetadata.operations}return[]};
SOS.entity.Capabilities.prototype.bindSourceXML=function(){var a=new SOS.source.XML;a.write=function(){return'<?xml version="1.0" encoding="UTF-8"?> <sos:GetCapabilities xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:sos="http://www.opengis.net/sos/2.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:swe="http://www.opengis.net/swe/2.0" service="SOS" xsi:schemaLocation="http://www.opengis.net/sos/2.0 http://schemas.opengis.net/sos/2.0/sosGetCapabilities.xsd"> <ows:AcceptVersions> <ows:Version>2.0.0</ows:Version> </ows:AcceptVersions> <ows:Sections> <ows:Section>ServiceIdentification</ows:Section> <ows:Section>ServiceProvider</ows:Section> <ows:Section>OperationsMetadata</ows:Section> <ows:Section>FilterCapabilities</ows:Section> </ows:Sections> </sos:GetCapabilities>'};return a};
SOS.entity.Capabilities.prototype.bindSourceJSON=function(){var a=new SOS.source.JSON;a.write=function(){return this.__proto__.write({request:"GetCapabilities",service:"SOS",sections:["ServiceIdentification","ServiceProvider","OperationsMetadata","FilterCapabilities","Contents"]})};return a};SOS.entity.DescribeSensor=function(a){this.capsOperation=this.entityName="DescribeSensor";SOS.Entity.apply(this,arguments);this.responseFormatType=a.responseFormatType||"http://www.opengis.net/sensorml/2.0";this.onCapAllowedProcedures=[];this.onCapAllowedProceduresDescFormat=[]};SOS.inherit(SOS.entity.DescribeSensor,SOS.Entity);
SOS.entity.DescribeSensor.prototype.getDescribeSensor=function(a){var b=this;return new SOS.Promise(function(c,d){b.sos.getCapabilities().then(function(){b.getPostUrl().then(function(e){e&&0<e.length?b.getOnCapAllowedProceduresDescFormat().then(function(e){a.procedureDescriptionFormat||("string"==typeof b.onCapAllowedProceduresDescFormat?a.procedureDescriptionFormat=b.onCapAllowedProceduresDescFormat:b.onCapAllowedProceduresDescFormat instanceof Array&&1==b.onCapAllowedProceduresDescFormat.length?
a.procedureDescriptionFormat=b.onCapAllowedProceduresDescFormat[0]:-1<b.onCapAllowedProceduresDescFormat.indexOf(b.responseFormatType)?a.procedureDescriptionFormat=b.responseFormatType:a.procedureDescriptionFormat=b.onCapAllowedProceduresDescFormat[0]);SOS.Request.POST({url:b.postUrl,async:b.sos.config.async,failure:function(a){console.log(SOS.Const.ErrorText.SOS_SENSOR_DESCRIPTION_ERROR);console.log(a);d(SOS.Const.ErrorText.SOS_SENSOR_DESCRIPTION_ERROR+" :"+a)},success:function(a){b.data&&(a&&a.responseText&&
b.get.read(a.responseText),b.sos.SOSSensorDescription=b.data.DescribeSensorResponse,b.sos.events.triggerEvent(SOS.Const.Events.SOS_SENSOR_DESCRIPTION_AVAILABLE),c(b.sos.SOSSensorDescription))},data:b.get.write(a)})}):c([])})})})};
SOS.entity.DescribeSensor.prototype.getOnCapAllowedProceduresDescFormat=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){0==a.onCapAllowedProceduresDescFormat.length&&(a.onCapAllowedProceduresDescFormat=a.sos.capsFormatter.getOperationParameterValues("DescribeSensor","procedureDescriptionFormat"));b(a.onCapAllowedProceduresDescFormat)})})};
SOS.entity.DescribeSensor.prototype.getOnCapAllowedProcedures=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){0==a.onCapAllowedProcedures.length&&(a.onCapAllowedProcedures=a.sos.capsFormatter.getOperationParameterValues("DescribeSensor","procedure"));b(a.onCapAllowedProcedures)})})};
SOS.entity.DescribeSensor.prototype.bindSourceXML=function(){var a=new SOS.source.XML({required:[]});a.write=function(a){this.__proto__.write(a,["idProcedure","procedureDescriptionFormat"]);return'<?xml version="1.0" encoding="UTF-8"?> <swes:DescribeSensor xmlns:swes="http://www.opengis.net/swes/2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:gml="http://www.opengis.net/gml/3.2" service="SOS" version="2.0.0" xsi:schemaLocation="http://www.opengis.net/swes/2.0 http://schemas.opengis.net/swes/2.0/swes.xsd"> <swes:procedure>'+
a.idProcedure+"</swes:procedure> "+(a.procedureDescriptionFormat?"<swes:procedureDescriptionFormat>"+a.procedureDescriptionFormat+"</swes:procedureDescriptionFormat> ":" ")+"</swes:DescribeSensor>"};return a};
SOS.entity.DescribeSensor.prototype.bindSourceJSON=function(){var a=new SOS.source.JSON;a.write=function(a){var c={request:"DescribeSensor",service:"SOS",version:"2.0.0",procedure:a.idProcedure};a.procedureDescriptionFormat&&(c.procedureDescriptionFormat=a.procedureDescriptionFormat);return this.__proto__.write(c)};return a};SOS.entity.FeatureOfInterest=function(a){this.entityName="FeatureOfInterest";this.capsOperation="GetFeatureOfInterest";SOS.Entity.apply(this,arguments);this.allowedFOIs=[];this.onCapAllowedFOIs=[];this.onCapAllowedProcedures=[];this.onCapAllowedObservedProperty=[];this.onCapAllowedIDFeaturesOfInterest=[];this.onCapAllowedRangeSpatialFilter=null;this.valueReference=a.valueReference||"sams:shape"};SOS.inherit(SOS.entity.FeatureOfInterest,SOS.Entity);
SOS.entity.FeatureOfInterest.prototype._bindFOI=function(a){return new SOS.entity.FeatureOfInterestRecord(SOS.Utils.extend(a,{sos:this.sos}))};
SOS.entity.FeatureOfInterest.prototype.getFeatureOfInterest=function(a,b){var c=this;return new SOS.Promise(function(d,e){c.sos.getCapabilities().then(function(){c.getPostUrl().then(function(g){g&&0<g.length?SOS.Request.POST({url:g,async:c.sos.config.async,failure:function(a){console.log(SOS.Const.ErrorText.SOS_FEATURE_OF_INTEREST_ERROR);console.log(a);e(SOS.Const.ErrorText.SOS_FEATURE_OF_INTEREST_ERROR+" :"+a)},success:function(a){a&&a.responseText&&c.get.read(a.responseText);if(c.data){a=[];c.allowedFOIs=
[];c.sos.SOSFeatureOfInterest=a=c.data.featureOfInterest||c.data.GetFeatureOfInterestResponse&&c.data.GetFeatureOfInterestResponse.featureMember||[];if(a instanceof Array)for(var e=0;e<a.length;e++)(a[e].sF_SpatialSamplingFeature||a[e])&&c.allowedFOIs.push(c._bindFOI(a[e].sF_SpatialSamplingFeature||a[e]));else for(e in a)c.allowedFOIs.push(c._bindFOI(a[e]));d(c.allowedFOIs);c.sos.events.triggerEvent(SOS.Const.Events.SOS_FEATURE_OF_INTEREST_AVAILABLE)}b&&b()},data:c.get.write(a)}):d([])})})})};
SOS.entity.FeatureOfInterest.prototype.getFeatureOfInterestByPoint=function(a,b,c,d,e){if(!a)throw Error(SOS.Const.ErrorText.FOI.SOS_FOI_GET_BY_POINT_SRS_MISSING);if(!b)throw Error(SOS.Const.ErrorText.FOI.SOS_FOI_GET_BY_POINT_COORDS_MISSING);if(!(b instanceof Array)||b instanceof Array&&2!=b.length)throw Error(SOS.Const.ErrorText.FOI.SOS_FOI_GET_BY_POINT_COORDS_MISSING);if(!c)throw Error(SOS.Const.ErrorText.FOI.SOS_FOI_GET_BY_POINT_RADIUS_MISSING);d=d||{};var g=[],f=new SOS.Utils.Converter.DataTypeConverter;
g.push(f.createConverter(SOS.Utils.Converter.Types.FLOAT));g.push(f.createConverter(SOS.Utils.Converter.Types.INT));for(f=0;f<g.length;f++)g[f].is(c)&&g[f].convert(c);b=SOS.Utils.Geom.createBBox(b,c);d.spatial={srs:a,lowerCorner:b.lowerCorner,upperCorner:b.upperCorner};return this.getFeatureOfInterest(d,e)};
SOS.entity.FeatureOfInterest.prototype.getProcedures=function(a,b){var c=this,d=[];a instanceof Array||(a=[a]);return new SOS.Promise(function(b,g){c.sos.getOfferingList(SOS.offeringType.SOS_2).then(function(f){f=f||[];f instanceof Array||(f=[f]);for(var g=0;g<a.length;g++)for(var k=0;k<f.length;k++){var l=f[k];l.featureOfInterestIds&&l.featureOfInterestIds instanceof Array&&-1<l.featureOfInterestIds.indexOf(a[g])&&c.sos.getOffering(l.identifier).then(function(a){d=d.concat(a.procedures)})}b(d)})})};
SOS.entity.FeatureOfInterest.prototype.getAllowedFOIs=function(){return this.allowedFOIs||[]};SOS.entity.FeatureOfInterest.prototype.getOnCapAllowedProcedures=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){0==a.onCapAllowedProcedures.length&&(a.onCapAllowedProcedures=a.sos.capsFormatter.getOperationParameterValues("GetFeatureOfInterest","procedure"));b(a.onCapAllowedProcedures)})})};
SOS.entity.FeatureOfInterest.prototype.getOnCapAllowedObservedProperty=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){0==a.onCapAllowedObservedProperty.length&&(a.onCapAllowedObservedProperty=a.sos.capsFormatter.getOperationParameterValues("GetFeatureOfInterest","observedProperty"));b(a.onCapAllowedObservedProperty)})})};
SOS.entity.FeatureOfInterest.prototype.getOnCapAllowedIDFeaturesOfInterest=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){0==a.onCapAllowedIDFeaturesOfInterest.length&&(a.onCapAllowedIDFeaturesOfInterest=a.sos.capsFormatter.getOperationParameterValues("GetFeatureOfInterest","featureOfInterest"));b(a.onCapAllowedIDFeaturesOfInterest)})})};
SOS.entity.FeatureOfInterest.prototype.getOnCapAllowedRangeSpatialFilter=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){if(null==a.onCapAllowedRangeSpatialFilter){var c=a.sos.capsFormatter.getOperationParameterValues("GetFeatureOfInterest","spatialFilter");c instanceof Object&&(a.onCapAllowedRangeSpatialFilter={min:c.min&&c.min.split(" ")||c.range&&c.range.minimumValue.split(" "),max:c.max&&c.max.split(" ")||c.range&&c.range.maximumValue.split(" ")})}b(a.onCapAllowedRangeSpatialFilter)})})};
SOS.entity.FeatureOfInterest.prototype.getAvailableFeaturesOfInterest=function(){var a=this;return new SOS.Promise(function(b,c){a.sos.getCapabilities().then(function(){var b=function(b){b&&b.responseText&&a.get.read(b.responseText);if(a.data&&a.data.GetFeatureOfInterestResponse&&a.data.GetFeatureOfInterestResponse.featureMember){b=a.data.GetFeatureOfInterestResponse.featureMember;for(var c=0;c<b.length;c++)a.onCapAllowedFOIs.push(a._bindFOI(b[c].sF_SpatialSamplingFeature||b[c]))}a.sos.events.triggerEvent(SOS.Const.Events.SOS_FEATURES_OF_INTEREST_AVAILABLE,
{item:a.onCapAllowedFOIs})};0==a.onCapAllowedIDFeaturesOfInterest.length&&(a.onCapAllowedIDFeaturesOfInterest=a.sos.capsFormatter.getOperationParameterValues("GetFeatureOfInterest","featureOfInterest"));0<a.onCapAllowedIDFeaturesOfInterest.length&&0==a.onCapAllowedFOIs.length&&a.getFeatureOfInterest({featuresOfInterest:a.onCapAllowedIDFeaturesOfInterest},b)})})};
SOS.entity.FeatureOfInterest.prototype.bindSourceXML=function(){var a=this,b=new SOS.source.XML({required:[]});b.write=function(b){this.__proto__.write(b,["procedure","observedProperty","featureOfInterest","spatial"]);if(b.spatial){if(!b.spatial.srs)throw Error(SOS.Const.ErrorText.XML.WRONG_PARAM);if(!b.spatial.lowerCorner||b.spatial.lowerCorner&&!(b.spatial.lowerCorner instanceof Array))throw Error(SOS.Const.ErrorText.XML.WRONG_PARAM);if(!b.spatial.upperCorner||b.spatial.upperCorner&&!(b.spatial.upperCorner instanceof
Array))throw Error(SOS.Const.ErrorText.XML.WRONG_PARAM);}var d={procedure:"<sos:procedure>filter</sos:procedure> ",observedProperty:"<sos:observedProperty>filter</sos:observedProperty> ",featureOfInterest:"<sos:featureOfInterest>filter</sos:featureOfInterest> "},e=function(a,b){for(var c=0;c<b.length;c++)g+=d[a].replace(/filter/g,b[c])},g='<?xml version="1.0" encoding="UTF-8"?> <sos:GetFeatureOfInterest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:sos="http://www.opengis.net/sos/2.0" xmlns:fes="http://www.opengis.net/fes/2.0" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:swe="http://www.opengis.net/swe/2.0" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:swes="http://www.opengis.net/swes/2.0" service="SOS" version="2.0.0" xsi:schemaLocation="http://www.opengis.net/sos/2.0 http://schemas.opengis.net/sos/2.0/sos.xsd"> ';
b.procedure&&e("procedure",b.procedure instanceof Array?b.procedure:[b.procedure]);b.observedProperty&&e("observedProperty",b.observedProperty instanceof Array?b.observedProperty:[b.observedProperty]);b.featureOfInterest&&e("featureOfInterest",b.featureOfInterest instanceof Array?b.featureOfInterest:[b.featureOfInterest]);b.spatial&&b.spatial.srs&&b.spatial.lowerCorner&&1<b.spatial.lowerCorner.length&&b.spatial.upperCorner&&1<b.spatial.upperCorner.length&&(g+="<sos:spatialFilter> <fes:BBOX> <fes:ValueReference>"+
a.valueReference+'</fes:ValueReference> <gml:Envelope srsName="'+(0>b.spatial.srs.toString().indexOf("/")?"http://www.opengis.net/def/crs/EPSG/0/"+b.spatial.srs.toString()+'"':b.spatial.srs)+"> <gml:lowerCorner>"+b.spatial.lowerCorner[0]+" "+b.spatial.lowerCorner[1]+"</gml:lowerCorner> <gml:upperCorner>"+b.spatial.upperCorner[0]+" "+b.spatial.upperCorner[1]+"</gml:upperCorner> </gml:Envelope> </fes:BBOX> </sos:spatialFilter> ");return g+="</sos:GetFeatureOfInterest> "};return b};
SOS.entity.FeatureOfInterest.prototype.bindSourceJSON=function(a){a=new SOS.source.JSON;a.write=function(a){var c={request:"GetFeatureOfInterest",service:"SOS",version:"2.0.0"};a.featureOfInterest&&(c.featureOfInterest=a.featureOfInterest instanceof Array?a.featureOfInterest:[a.featureOfInterest]);a.observedProperty&&(c.observedProperty=a.observedProperty instanceof Array?a.observedProperty:[a.observedProperty]);a.procedure&&(c.procedure=a.procedure instanceof Array?a.procedure:[a.procedure]);a.spatial&&
a.spatial.geomType&&a.spatial.coordinates&&(c.spatialFilter={bbox:{ref:"om:featureOfInterest/sams:SF_SpatialSamplingFeature/sams:shape",value:{type:a.spatial.geomType,coordinates:a.spatial.coordinates}}});return this.__proto__.write(c)};return a};SOS.entity.FeatureOfInterestRecord=function(a){this.entityName="FeatureOfInterestRecord";this.id=a["@id"]||a.id||"";this.idFOI=a.identifier&&(a.identifier["#text"]||a.identifier.value)||a.idFOI||"";this.type=a.type&&a.type["@href"]||a.type||"";this.name=a.name&&(a.name["#text"]||a.name.value)||"";this.sampledFeature=a.sampledFeature&&(a.sampledFeature["@href"]||a.sampledFeature)||"";if(a.shape||a.geometry){var b={};if(a.geometry)b.type=a.geometry.type,b.srs=a.geometry.srs,b.coords=a.geometry.coordinates;
else for(var c in a.shape)if(a.shape[c]["@id"]&&(b.type=a.shape[c]["@id"].split("_").shift()),a.shape[c].pos&&(a.shape[c].pos["@srsName"]&&(b.srs=a.shape[c].pos["@srsName"].split("/").pop()),a.shape[c].pos["#text"])){b.coords=a.shape[c].pos["#text"].split(" ");for(var d=0;d<b.coords.length;d++)b.coords[d]=parseInt(b.coords[d])}b.type&&b.srs&&b.coords&&(this.geom=b)}else this.geom={}};SOS.entity.Observation=function(a){var b=this;b.entityName="Observation";b.capsOperation="GetObservation";SOS.Entity.apply(b,arguments);b.filters={};b.sortByDateTime=a.sortByDateTime||!0;b.valueReference=a.valueReference||"om:featureOfInterest/sams:SF_SpatialSamplingFeature/sams:shape";b.sos.registerUserCallback({event:SOS.Const.Events.SOS_CAPABILITIES_AVAILABLE,callback:function(){b._bindFiltersByCapabilities()}})};SOS.inherit(SOS.entity.Observation,SOS.Entity);
SOS.entity.Observation.prototype._bindFiltersByCapabilities=function(){if(this.sos.capsFormatter.data&&this.sos.capsFormatter.data.filterCapabilities){var a=this.sos.capsFormatter.data.filterCapabilities.filter_Capabilities&&this.sos.capsFormatter.data.filterCapabilities.filter_Capabilities.temporal_Capabilities||this.sos.capsFormatter.data.filterCapabilities.temporal,b=null;a?b=a.operands:a.temporal_Capabilities&&(b=a.temporalOperands&&a.temporal_Capabilities.temporalOperands);this.sos.obsFormatter.filters.temporalOperands=
{};if(b instanceof Array)for(var c=0;c<b.length;c++){var d=b[c].$ref.split("/").pop().replace("#","");this.sos.obsFormatter.filters.temporalOperands[d]=d}else if(b instanceof Object&&b.temporalOperand&&(b=a.temporalOperands.temporalOperand,b instanceof Array))for(c=0;c<b.length;c++)d=b[c]["@name"].split(":").pop(),this.sos.obsFormatter.filters.temporalOperands[d]=d;this.sos.obsFormatter.filters.temporalOperators={};b=a.temporalOperators&&a.temporalOperators.temporalOperator||a.operators;if(b instanceof
Array)for(c=0;c<b.length;c++)a=b[c]["@name"],this.sos.obsFormatter.filters.temporalOperators[a]=a;else if(b instanceof Object&&SOS.Utils.isValidObject(b))for(var e in b)this.sos.obsFormatter.filters.temporalOperators[e]=e}};SOS.entity.Observation.prototype.getDataAvailable=function(){};
SOS.entity.Observation.prototype.getObservation=function(a,b,c,d){var e=this;c instanceof SOS.Offering&&(d=c,c=null);return new SOS.Promise(function(g,f){e.sos.getCapabilities().then(function(){e.getPostUrl().then(function(h){h&&0<h.length?SOS.Request.POST({url:h,async:e.sos.config.async,failure:function(a){console.log(SOS.Const.ErrorText.SOS_OBSERVATION_ERROR);console.log(a);f(SOS.Const.ErrorText.SOS_OBSERVATION_ERROR+" :"+a)},success:function(a){a&&a.responseText&&e.get.read(a.responseText);if(e.data){e.data.GetObservationResponse&&
e.data.GetObservationResponse.observationData&&(e.data=e.sos.SOSObservations=e.data.GetObservationResponse.observationData);e.sortByDateTime&&e.data instanceof Array?e.data=e.data.sort(e._sortObservations):e.data.oM_Observation&&(e.data=e.sos.SOSObservations=e.data.oM_Observation);a=[];if(e.data instanceof Array)for(var f=0;f<e.data.length;f++)a.push(new SOS.entity.ObservationRecord(e.data[f]));else a.push(new SOS.entity.ObservationRecord(e.data));a&&(e.data=e.sos.SOSObservations=a);d?(d.observationData=
a,e.sos.events.triggerEvent(SOS.Const.Events.SOS_OFFERING_OBSERVATION_AVAILABLE)):e.sos.events.triggerEvent(c||SOS.Const.Events.SOS_OBSERVATION_AVAILABLE);g(a)}b&&b(e.data)},data:e.get.write(a)}):g([])})})})};SOS.entity.Observation.prototype.getObservationFirst=function(a,b,c){a=a||{};a.temporal={operator:"TEquals",on:"resultTime",operand:"TimeInstant",timeEvent:"getFirst"};return this.getObservation(a,b,SOS.Const.Events.SOS_FIRST_OBSERVATION_AVAILABLE,c)};
SOS.entity.Observation.prototype.getObservationLatest=function(a,b,c){a=a||{};a.temporal={operator:"TEquals",on:"resultTime",operand:"TimeInstant",timeEvent:"latest"};return this.getObservation(a,b,SOS.Const.Events.SOS_LATEST_OBSERVATION_AVAILABLE,c)};
SOS.entity.Observation.prototype.getObservationFromTo=function(a,b,c){a=a||{};a.temporal&&SOS.Utils.extend(a.temporal,{operator:"During",on:"resultTime",operand:"TimePeriod"});return this.getObservation(a,b,SOS.Const.Events.SOS_OBSERVATION_AVAILABLE,c)};SOS.entity.Observation.prototype.getFeatureOfInterest=function(a){a=a||{foisIndex:0,featuresIndex:0};return _ent.data.fois[a.foisIndex].features[a.featuresIndex]};
SOS.entity.Observation.prototype._sortObservations=function(a,b){var c=0,d=a.oM_Observation.resultTime.timeInstant||a.oM_Observation.phenomenonTime.timeInstant,e=b.oM_Observation.resultTime.timeInstant||b.oM_Observation.phenomenonTime.timeInstant;d.timePosition<e.timePosition?c=-1:d.timePosition>e.timePosition&&(c=1);return c};
SOS.entity.Observation.prototype.bindSourceXML=function(){var a=this,b=new SOS.source.XML({required:[]});b.write=function(b){this.__proto__.write(b,"offering procedure observedProperty featureOfInterest temporal spatial responseFormat".split(" "));var d={offering:"<sos:offering>filter</sos:offering> ",procedure:"<sos:procedure>filter</sos:procedure> ",observedProperty:"<sos:observedProperty>filter</sos:observedProperty> ",featureOfInterest:"<sos:featureOfInterest>filter</sos:featureOfInterest> "},
e=function(a,b){for(var c=0;c<b.length;c++)g+=d[a].replace(/filter/g,b[c])},g='<?xml version="1.0" encoding="UTF-8"?> <sos:GetObservation xmlns:sos="http://www.opengis.net/sos/2.0" xmlns:fes="http://www.opengis.net/fes/2.0" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:swe="http://www.opengis.net/swe/2.0" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:swes="http://www.opengis.net/swes/2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" service="SOS" version="2.0.0" xsi:schemaLocation="http://www.opengis.net/sos/2.0 http://schemas.opengis.net/sos/2.0/sos.xsd"> ';
b.procedure&&e("procedure",b.procedure instanceof Array?b.procedure:[b.procedure]);b.offering&&e("offering",b.offering instanceof Array?b.offering:[b.offering]);b.observedProperty&&e("observedProperty",b.observedProperty instanceof Array?b.observedProperty:[b.observedProperty]);if(b.temporal&&b.temporal.operator&&b.temporal.on&&(b.temporal.start&&b.temporal.end||b.temporal.timeEvent)){var f=function(a){var b=new Date(a.getTime()+6E4*a.getTimezoneOffset()),c=a.getTimezoneOffset()/60;a=a.getHours();
b.setHours(a-c);return b.toISOString().replace(/\.\d+Z$/,"Z")};if(b.temporal.start&&b.temporal.end)var h=SOS.Utils.isoToTimeInterval(b.temporal.start,b.temporal.end),h=SOS.Utils.adjustTimeInterval(h,-1,1);g+="<sos:temporalFilter> <fes:"+b.temporal.operator+"> <fes:ValueReference>"+b.temporal.on+"</fes:ValueReference> <gml:"+b.temporal.operand+' gml:id="tp_1"> ';switch(b.temporal.operand){case "TimePeriod":g+="<gml:beginPosition>"+(h&&f(h.start)||"")+"</gml:beginPosition> ";g+="<gml:endPosition>"+
(h&&f(h.end)||"")+"</gml:endPosition> ";break;case "TimeInstant":b.temporal.timeEvent instanceof Date?(h=SOS.Utils.isoToTimeInterval(b.temporal.timeEvent),g+="<gml:timePosition>"+(h&&f(b.temporal.timeEvent)||"")+"</gml:timePosition> "):g+="<gml:timePosition>"+b.temporal.timeEvent+"</gml:timePosition> "}g+="</gml:"+b.temporal.operand+"> </fes:"+b.temporal.operator+"> </sos:temporalFilter>"}b.featureOfInterest&&e("featureOfInterest",b.featureOfInterest instanceof Array?b.featureOfInterest:[b.featureOfInterest]);
b.spatial&&b.spatial.srs&&b.spatial.lowerCorner&&1<b.spatial.lowerCorner.length&&b.spatial.upperCorner&&1<b.spatial.upperCorner.length&&(g+="<sos:spatialFilter> <fes:BBOX> <fes:ValueReference>"+a.valueReference+'</fes:ValueReference> <gml:Envelope srsName="'+(0>b.spatial.srs.toString().indexOf("/")?"http://www.opengis.net/def/crs/EPSG/0/"+b.spatial.srs.toString()+'"':b.spatial.srs)+"> <gml:lowerCorner>"+b.spatial.lowerCorner[0]+" "+b.spatial.lowerCorner[1]+"</gml:lowerCorner> <gml:upperCorner>"+b.spatial.upperCorner[0]+
" "+b.spatial.upperCorner[1]+"</gml:upperCorner> </gml:Envelope> </fes:BBOX> </sos:spatialFilter> ");b.responseFormat&&(g+="<sos:responseFormat>"+b.responseFormat+"</sos:responseFormat>");return g+="</sos:GetObservation> "};return b};
SOS.entity.Observation.prototype.bindSourceJSON=function(){var a=this;(new SOS.source.JSON).write=function(){var b={request:"GetObservation",service:"SOS",version:"2.0.0"};params.procedures&&(b.procedure=params.procedures instanceof Array?params.procedures:[params.procedures]);params.offering&&(b.offering=params.offering instanceof Array?params.offering:[params.offering]);params.observedProperties&&(b.observedProperty=params.observedProperties instanceof Array?params.observedProperties:[params.observedProperties]);
params.featuresOfInterest&&(b.featureOfInterest=params.featuresOfInterest instanceof Array?params.featuresOfInterest:[params.featuresOfInterest]);params.spatial&&params.spatial.geomType&&params.spatial.coordinates&&(b.spatialFilter={bbox:{ref:a._spatialShapeProperty,value:{type:params.spatial.geomType,coordinates:params.spatial.coordinates}}});if(params.temporal&&params.temporal.operator&&params.temporal.on&&(params.temporal.start&&params.temporal.end||params.temporal.timeEvent)){if(params.temporal.start&&
params.temporal.end)var c=SOS.Utils.isoToTimeInterval(params.temporalFilter.start,params.temporalFilter.end),c=SOS.Utils.adjustTimeInterval(c,-1,1);b.temporalFilter={};b.temporalFilter[params.temporal.operator]={ref:arams.temporalFilter.on};b.temporalFilter[params.temporal.operator].value=params.temporal.start&&params.temporal.end&&c?[c.start.toISOString().replace(/\.\d+Z$/,"Z"),c.end.toISOString().replace(/\.\d+Z$/,"Z")]:params.temporal.timeEvent}return this.__proto__.write(b)}};SOS.entity.ObservationRecord=function(a){this.entityName="ObservationRecord";a.oM_Observation&&(a=a.oM_Observation);this.id=a["@id"]||a.id;this.featuresOfInterest=[];if(a.featureOfInterest instanceof Array)for(var b=0;b<a.featureOfInterest.length;b++)this.featuresOfInterest.push({id:a.featureOfInterest[b]["@href"]||a.featureOfInterest[b].id,name:a.featureOfInterest[b]["@title"]||a.featureOfInterest[b].name});else this.featuresOfInterest.push({id:a.featureOfInterest["@href"]||a.featureOfInterest.id,
name:a.featureOfInterest["@title"]||a.featureOfInterest.name});this.observedProperty=[];if(a.observedProperty instanceof Array)for(b=0;b<a.observedProperty.length;b++)this.observedProperty.push(a.observedProperty[b]["@href"]||a.observedProperty[b]);else this.observedProperty.push(a.observedProperty["@href"]||a.observedProperty);var c=function(a){a=new Date(a);var b=new Date(a.getTime()+6E4*a.getTimezoneOffset()),c=a.getTimezoneOffset()/60;a=a.getHours();b.setHours(a+c);return b};a.phenomenonTime.timeInstant?
this.time=c(a.phenomenonTime.timeInstant.timePosition):a.phenomenonTime.timePeriod?this.time=[c(a.phenomenonTime.timePeriod.beginPosition),c(a.phenomenonTime.timePeriod.endPosition)]:a.time&&(this.time=a.time);this.procedure=[];if(a.procedure instanceof Array)for(b=0;b<a.procedure.length;b++)this.procedure.push(a.procedure[b]["@href"]||a.procedure[b]);else this.procedure.push(a.procedure["@href"]||a.procedure);this.type=a.type&&a.type["@href"]?a.type["@href"]:a.type;if(a.result)if(c=[],b=new SOS.Utils.Converter.DataTypeConverter,
c.push(b.createConverter(SOS.Utils.Converter.Types.FLOAT)),c.push(b.createConverter(SOS.Utils.Converter.Types.INT)),a.result["@type"])switch(a.result["@type"].split(":").pop().toLowerCase()){case "referencetype":this.result={type:a.result["@title"],uom:"",value:""};break;case "boolean":this.result={uom:a.result["@uom"]||"",value:"true"==a.result["#text"]};break;case "integer":this.result={uom:a.result["@uom"]||"",value:parseInt(a.result["#text"])};break;case "string":this.result={uom:a.result["@uom"]||
"",value:a.result["#text"]};break;case "measuretype":var d=a.result["#text"];this.result={uom:a.result["@uom"],value:d};for(b=0;b<c.length;b++)if(c[b].is(d)){d=c[b].convert(d);this.result.value=d;break}}else this.result={type:a.result.type,uom:a.result.uom,value:a.result.value}};
