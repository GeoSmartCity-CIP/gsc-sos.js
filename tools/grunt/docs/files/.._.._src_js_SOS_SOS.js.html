<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>..\..\src\js\SOS\SOS.js - gsc-sos.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="gsc-sos.js"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Capabilities.html">Capabilities</a></li>
            
                <li><a href="../classes/DescribeSensor.html">DescribeSensor</a></li>
            
                <li><a href="../classes/FeatureOfInterest.html">FeatureOfInterest</a></li>
            
                <li><a href="../classes/FeatureOfInterestRecord.html">FeatureOfInterestRecord</a></li>
            
                <li><a href="../classes/Observation.html">Observation</a></li>
            
                <li><a href="../classes/ObservationById.html">ObservationById</a></li>
            
                <li><a href="../classes/ObservationRecord.html">ObservationRecord</a></li>
            
                <li><a href="../classes/Offering.html">Offering</a></li>
            
                <li><a href="../classes/SOS.html">SOS</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ..\..\src\js\SOS\SOS.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
﻿/// &lt;reference path=&quot;Entity/Entities/Capabilities.js&quot; /&gt;
/// &lt;reference path=&quot;Entity/Entities/DescribeSensor.js&quot; /&gt;
/// &lt;reference path=&quot;Entity/Entities/FeatureOfInterest.js&quot; /&gt;
/// &lt;reference path=&quot;Entity/Entities/Observation.js&quot; /&gt;
/// &lt;reference path=&quot;Entity/Entity.js&quot; /&gt;
/// &lt;reference path=&quot;Entity/Offering.js&quot; /&gt;
/// &lt;reference path=&quot;Method/Method.js&quot; /&gt;
/// &lt;reference path=&quot;Source/JSON/SourceJSON.js&quot; /&gt;
/// &lt;reference path=&quot;Source/XML/SourceXML.js&quot; /&gt;
/// &lt;reference path=&quot;Source/Source.js&quot; /&gt;



/**
 * Instancia un objeto SOS.
 * Es el objeto principal de la API.
 * Al instanciar la clase, automáticamente se lanza una petición getCapabilities al servcio indicado en el objeto de configuración. 
 *
 * @class SOS
 * @param {object} options { url: urlServicio } 
 * - Requerido: URL del servicio al cual se conectará 
 * @throws {Error} Lanza error cuando no se construye el objeto mediante new.
 * @throws {Error} Lanza error cuando no se indica URL al servicio o una instancia de SOS.
 */
var SOS = function (options) {

    if (!(this instanceof SOS)) throw new Error(&#x27;SOS &#x27; + SOS.Const.ErrorText.SOS_VIA_NEW);

    var _sos = this;

    // url del servicio
    _sos.url = null;

    _sos.capabilitiesPromise = null;
    // instancia del sos actual
    _sos.scope = null;
    // eventos
    _sos.events = null,

    // instancia de la entidad Capabilities, da acceso a los métodos y propiedades de la entidad
    _sos.capsFormatter = null,
    // instancia de la entidad Observation, da acceso a los métodos y propiedades de la entidad
    _sos.obsFormatter = null,
    // instancia de la entidad FeatureOfInterest, da acceso a los métodos y propiedades de la entidad
    _sos.foiFormatter = null,
    // instancia de la entidad DescribeSensor, da acceso a los métodos y propiedades de la entidad
    _sos.sensorDescFormatter = null,
    _sos.config = null,

    _sos.initialize(options);
};


/**
 * URL del servicio del cual obtendrá datos
 * @property url
 * @type string 
 */

/**
 * Promesa de la solicitud en curso del capabilities del servicio indicado
 * @property capabilitiesPromise
 * @type SOS.Promise 
 */

/**
 * Manejador de eventos
 * @property events
 * @type SOS.Events 
 */

/**
 * Instancia de la entidad Capabilities asociada al servicio
 * @property capsFormatter
 * @type SOS.entity.Capabilities 
 */

/**
 * Instancia de la entidad Observation asociada al servicio
 * @property obsFormatter
 * @type SOS.entity.Observation 
 */

/**
 * Instancia de la entidad FeatureOfInterest asociada al servicio
 * @property foiFormatter
 * @type SOS.entity.FeatureOfInterest 
 */

/**
 * Instancia de la entidad DescribeSensor asociada al servicio
 * @property sensorDescFormatter
 * @type SOS.entity.DescribeSensor 
 */

// Indicamos cómo nos comunicamos con el servicio, tanto solicitudes como las respuesta estarán con el tipo de binding indicado 
SOS.bindingType = {
    XML: &#x27;xml&#x27;,
    JSON: &#x27;json&#x27;
};

// Indicamos si queremos los offering con los atributos de sos 1.0 (menos atributos que en sos 2.0) o sos 2.0
SOS.offeringType = {
    SOS_1: &#x27;sos_1&#x27;,
    SOS_2: &#x27;sos_2&#x27;
};

SOS.Const = {};
SOS.Const.ErrorText = {
    SOS_VIA_NEW: &#x27; must be constructed via new&#x27;,
    SOS_URL_MISSING: &#x27;Error requiere URL del servicio&#x27;,
    SOS_CAPABILITIES_ERROR: &#x27;Error en la solicitud del capabilities&#x27;,
    SOS_SENSOR_DESCRIPTION_ERROR: &#x27;Error en la solicitud de la descripción&#x27;,
    SOS_FEATURE_OF_INTEREST_ERROR: &#x27;Error en la solicitud de features of interest&#x27;,
    SOS_OBSERVATION_ERROR: &#x27;Error en la solicitud de observaciones&#x27;,
    XML: {
        UNKNOWN_PARAM: &#x27;Error parámetro desconocido&#x27;,
        WRONG_PARAM: &#x27;Error parámetro incorrecto&#x27;,
        EMPTY_PARAM: &#x27;Error parámetro valor vacío&#x27;//&#x27;parameter value must have value&#x27;
    },
    FOI: {
        SOS_FOI_GET_BY_POINT_SRS_MISSING: &#x27;Error requiere SRS&#x27;,
        SOS_FOI_GET_BY_POINT_COORDS_MISSING: &#x27;Error requiere array con coordenadas&#x27;,
        SOS_FOI_GET_BY_POINT_RADIUS_MISSING: &#x27;Error requiere radio en unidad de medida del mapa&#x27;
    }
};
SOS.Const.Events = {
    SOS_CAPABILITIES_AVAILABLE: &#x27;sosCapabilitiesAvailable&#x27;,
    SOS_OFFERINGS_CAPABILITIES_AVAILABLE: &#x27;sosOffsCapabilitiesAvailable&#x27;,
    SOS_SENSOR_DESCRIPTION_AVAILABLE: &#x27;sosSensorDescriptionAvailable&#x27;,
    SOS_FEATURE_OF_INTEREST_AVAILABLE: &#x27;sosFeatureOfInterestAvailable&#x27;,
    SOS_FEATURES_OF_INTEREST_AVAILABLE: &#x27;sosFeaturesOfInterestAvailable&#x27;,
    SOS_OBSERVATION_AVAILABLE: &#x27;sosObservationAvailable&#x27;,
    SOS_LATEST_OBSERVATION_AVAILABLE: &#x27;sosLatestObservationAvailable&#x27;,
    SOS_OFFERING_OBSERVATION_AVAILABLE: &#x27;sosOfferingObsAvailable&#x27;,
    SOS_OFFERING_RESULT_AVAILABLE: &#x27;sosOfferingResultAvailable&#x27;,
    SOS_OBSERVATION_BY_ID_AVAILABLE: &#x27;sosObservationByIdAvailable&#x27;
};


SOS.prototype.getResponseFormatType = function (post) {
    switch (this.bindingType) {
        case &#x27;xml&#x27;:
            return &quot;text/xml&quot;;
            break;
        case &#x27;json&#x27;:
            return &quot;application/json&quot;;
            break;
    }
};

SOS.prototype.getResponseFormat = function () {
    switch (this.bindingType) {
        case &#x27;xml&#x27;:
            return &quot;text/xml;subtype=\&quot;om/1.0.0\&quot;&quot;;
            break;
        case &#x27;json&#x27;:
            return &quot;application/json;charset=UTF-8&quot;;
            break;
    }
};


SOS.prototype.initialize = function (options) {
    var _sos = this;

    _sos.url = null;

    if (!options.bindingType) {
        _sos.bindingType = _sos.bindingType.XML;
        console.log(&#x27;SOS bindingType missing.&#x27;);
    }
    else
        _sos.bindingType = options.bindingType;

    SOS.Proxy.init();

    _sos.url = null;
    _sos.config = {
        version: &quot;2.0.0&quot;,
        async: true,
        observation: {
            responseFormatType: _sos.getResponseFormatType(),
            responseFormat: _sos.getResponseFormat(),
            resultModel: &quot;om:Measurement&quot;
        },
        post: {
            setUrlFromCapabilities: true,
            constraint: &quot;Content-Type&quot;,
            responseFormatType: _sos.getResponseFormatType(true),
            url: null
        }
    };

    // contiene los offerings disponibles desde el capabilities
    _sos.availableOfferings = [];
    _sos.events = new SOS.Events();

    SOS.Utils.extend(_sos, options);

    if (options.entity &amp;&amp; options.entity instanceof SOS.entity.Observation)
        _sos.obsFormatter = options.entity;
    else _sos.obsFormatter = new SOS.entity.Observation({ sos: _sos, defaultSource: _sos.bindingType });

    if (options.entity &amp;&amp; options.entity instanceof SOS.entity.FeatureOfInterest)
        _sos.foiFormatter = options.entity;
    else _sos.foiFormatter = new SOS.entity.FeatureOfInterest({ sos: _sos, defaultSource: _sos.bindingType });

    if (options.entity &amp;&amp; options.entity instanceof SOS.entity.DescribeSensor)
        _sos.sensorDescFormatter = options.entity;
    else _sos.sensorDescFormatter = new SOS.entity.DescribeSensor({ sos: _sos, defaultSource: _sos.bindingType });

    if (options.entity &amp;&amp; options.entity instanceof SOS.entity.Capabilities)
        _sos.capsFormatter = options.entity;
    else _sos.capsFormatter = new SOS.entity.Capabilities({ sos: _sos, defaultSource: _sos.bindingType });


    /* By default, the POST URL is the same as the GET URL */
    if (this.url) {
        this.config.post.url = this.url;
    }
};


/**
 * Copy mandatory properties from &#x27;this&#x27; to the given object
 */
SOS.prototype.copyMandatoryObjectProperties = function (obj) {
    var _sos = this;

    if (typeof obj === &quot;object&quot;) {
        obj.config = _sos.config;
        obj.url = _sos.url;
    }

    return obj;
};

/**
 * Registrar la función suministrada como un controlador de eventos. 
 *
 * @method registerUserCallback
 * @param {object} params { event: evento, scope: this, callback: miFuncion }   
 * @example
        sos.registerUserCallback({
                event: SOS.Const.Events.SOS_SENSOR_DESCRIPTION_AVAILABLE,
                scope: this,
                callback: function () {
                    console.log(&#x27;Evento SOS_SENSOR_DESCRIPTION_AVAILABLE: &#x27;);                    
                    if (sos.sensorDescFormatter.data) {
                        console.log(&#x27;Descripción del sensor disponible&#x27;);                        
                    }
                }
        });
 */
SOS.prototype.registerUserCallback = function (params) {
    var _sos = this;

    if (SOS.Utils.isValidObject(params)) {
        if (typeof params.event === &quot;string&quot; &amp;&amp; typeof params.callback === &quot;function&quot;) {
            if (!SOS.Utils.isValidObject(params.scope)) {
                params.scope = this;
            }
            _sos.events.register(params.event, params.callback);
        }
    }
};

/**
 * Anula el registro de un controlador de eventos previamente asignada. 
 *
 * @method unregisterUserCallback
 * @param {object} params { event: evento, scope: this, callback: miFuncion }   
 */
SOS.prototype.unregisterUserCallback = function (params) {
    var _sos = this;

    if (SOS.Utils.isValidObject(params)) {
        if (typeof params.event === &quot;string&quot; &amp;&amp; typeof params.callback === &quot;function&quot;) {
            if (!SOS.Utils.isValidObject(params.scope)) {
                params.scope = _sos;
            }
            _sos.events.unregister(params.event, params.callback);
        }
    }
};

/**
 * Solicita el capabilities del servicio
 *
 * @method getCapabilities
 * @param {object} [callback] { callback: miFuncion }   
 * @return {SOS.Promise} Promesa
 * @example    
        var sos = new SOS({ url: &#x27;http://sos_service/service&#x27;, bindingType: SOS.bindingType.XML });        
        sos.getCapabilities().then(function (data) {            
            console.log(&#x27;Capabilities OK&#x27;);
        });
 */
SOS.prototype.getCapabilities = function (callback) {
    var _sos = this;

    var options = {
        scope: _sos,
        callback: callback
    }

    return new SOS.Promise(function (resolve, reject) {
        _sos.capsFormatter.getCapabilities(options).then(function (data) {
            resolve(data);
        });
    });
};

/**
 * Solicita los offerings disponibles en el capabilities
 *
 * @method getCapabilitiesOfferings
 * @param {object} [callback] { callback: miFuncion }   
 * @return {SOS.Promise} Promesa
 * @example    
        var sos = new SOS({ url: &#x27;http://sos_service/service&#x27;, bindingType: SOS.bindingType.XML });        
        sos.getCapabilitiesOfferings().then(function (data) {            
            console.log(&#x27;Offerings OK&#x27;);
        });
 */
SOS.prototype.getCapabilitiesOfferings = function (callback) {
    var _sos = this;

    SOS.OffsCapabilities = SOS.OffsCapabilities || {};

    if (!SOS.OffsCapabilities[_sos.url] &amp;&amp; !(_sos.offsCapabilitiesPromise instanceof SOS.Promise)) {

        var getCaps = function (resolve, reject) {
            var _parse = function (response) {
                if (response &amp;&amp; response.responseText) {
                    if (response.responseText.indexOf(&quot;ExceptionText&quot;) &gt; 0)
                        reject(&#x27;Error getCapabilities&#x27;);
                    else {
                        var data = new SOS.source.XML().read(response.responseText);
                        // limpiamos referencias
                        if (data.Capabilities)
                            data = data.Capabilities;

                        SOS.OffsCapabilities[_sos.url] = data;

                        _sos.events.triggerEvent(SOS.Const.Events.SOS_OFFERINGS_CAPABILITIES_AVAILABLE);

                        resolve(SOS.OffsCapabilities[_sos.url]);

                        // limpiamos la promesa ya resuelta
                        _sos.offsCapabilitiesPromise = null;
                    }
                }
            };

            if (callback) {
                _sos.registerUserCallback({ event: SOS.Const.Events.SOS_OFFERINGS_CAPABILITIES_AVAILABLE, callback: callback });
            }

            var getRequest = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &#x27; +
                &#x27;&lt;sos:GetCapabilities &#x27; +
                    &#x27;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &#x27; +
                    &#x27;xmlns:sos=&quot;http://www.opengis.net/sos/2.0&quot; &#x27; +
                    &#x27;xmlns:ows=&quot;http://www.opengis.net/ows/1.1&quot; &#x27; +
                    &#x27;xmlns:swe=&quot;http://www.opengis.net/swe/2.0&quot; service=&quot;SOS&quot; xsi:schemaLocation=&quot;http://www.opengis.net/sos/2.0 http://schemas.opengis.net/sos/2.0/sosGetCapabilities.xsd&quot;&gt; &#x27; +
                    &#x27;&lt;ows:AcceptVersions&gt; &#x27; +
                        &#x27;&lt;ows:Version&gt;2.0.0&lt;/ows:Version&gt; &#x27; +
                    &#x27;&lt;/ows:AcceptVersions&gt; &#x27; +
                    &#x27;&lt;ows:Sections&gt; &#x27; +
                        &#x27;&lt;ows:Section&gt;Contents&lt;/ows:Section&gt; &#x27; +
                    &#x27;&lt;/ows:Sections&gt; &#x27; +
                &#x27;&lt;/sos:GetCapabilities&gt;&#x27;;


            SOS.Request.POST({
                url: _sos.url,
                headers: {
                    &quot;Content-Type&quot;: _sos.capsFormatter.getContentType()
                },
                data: getRequest,
                scope: _sos,
                async: _sos.async,
                failure: function (error) {
                    reject(&#x27;Error getOfferingsCapabilities - &#x27; + _sos.url);
                },
                success: _parse
            });
        };

        _sos.offsCapabilitiesPromise = new SOS.Promise(getCaps);

        return _sos.offsCapabilitiesPromise;

    } else if (_sos.offsCapabilitiesPromise instanceof SOS.Promise) {

        return _sos.offsCapabilitiesPromise;
    }
    else {
        return new SOS.Promise(function (resolve, reject) {
            resolve(SOS.OffsCapabilities[_sos.url]);
        });
    }
};

/**
 * Validate the internal capabilities object
 */
SOS.prototype.haveValidCapabilitiesObject = function () {
    var _sos = this;

    return SOS.Utils.isValidObject(_sos.capsFormatter.data);
};

/**
 * Set the config.observation.responseFormat member to an available
 * format of the given type, parsed from the capabilities object
 */
SOS.prototype.setObservationResponseFormatFromTypeSuggestion = function (type) {
    var _sos = this;

    if (this.haveValidCapabilitiesObject()) {
        if (SOS.Utils.isValidObject(_sos.capsFormatter.data)) {
            var allowedValues = _sos.capsFormatter.getOperationParameterValues(&#x27;GetObservation&#x27;, &#x27;responseFormat&#x27;);

            if (allowedValues) {
                for (var i = 0; i &lt; allowedValues.length; i++) {
                    if (allowedValues[i].indexOf(type) &gt;= 0) {
                        this.config.observation.responseFormat = allowedValues[i];
                        break;
                    }
                }
            }
        }
    }
};


SOS.prototype.getOfferingList = function (sosOfferingType) {
    var _sos = this;

    sosOfferingType = sosOfferingType || SOS.offeringType.SOS_2;

    var get = function (resolve, reject) {
        _sos.getCapabilitiesOfferings().then(function () {
            switch (sosOfferingType) {
                case &#x27;sos_1&#x27;:
                    resolve(_sos.getSimpleOfferings());
                    break;
                case &#x27;sos_2&#x27;:
                    resolve(_sos.getOfferings());
                    break;
            }
        });
    };

    return new SOS.Promise(get);
};

SOS.prototype._bindOfferings = function () {
    var _sos = this;

    SOS.OffsCapabilities = SOS.OffsCapabilities || {};

    var capabilities = SOS.OffsCapabilities[_sos.url];
    if (capabilities) {

        var offeringList = {};

        // limpiamos refencias
        if (capabilities &amp;&amp; capabilities.contents[&#x27;contents&#x27;])
            capabilities.contents = capabilities.contents.contents.offering;

        var getObservedArea = function (off) {
            var obsArea = off.observedArea || off.observedArea &amp;&amp; off.observedArea.envelope || null;
            if (obsArea) {
                return {
                    crs: off.observedArea.envelope[&#x27;@srsName&#x27;].split(&#x27;/&#x27;).pop(),
                    lowerCorner: off.observedArea.envelope.lowerCorner.split(&#x27; &#x27;),
                    upperCorner: off.observedArea.envelope.upperCorner.split(&#x27; &#x27;)
                };
            }
            else return {};
        };
        var getFOI = function (off) {
            var foiID = [];
            for (var property in off) {
                if (property == &#x27;relatedFeature&#x27;) {
                    if (off[property].featureRelationship)
                        foiID.push(off[property].featureRelationship.target[&#x27;@href&#x27;]);
                }
            }

            return foiID;
        };

        var contentsIsArray = function (c) {
            for (var i = 0; i &lt; c.length; i++) {
                var off = c[i].observationOffering || c[i];
                if (off) {
                    _sos.availableOfferings.push(new SOS.Offering({
                        sos: _sos,
                        bindingType: SOS.bindingType.JSON,
                        identifier: off.identifier,
                        name: off.name &amp;&amp; off.name[&#x27;#text&#x27;] || &#x27;&#x27;,
                        featureOfInterestType: off.featureOfInterestType,
                        featureOfInterestIds: getFOI(off),
                        observedProperties: off.observableProperty,
                        observationType: off.observationType,
                        observedArea: getObservedArea(off),
                        phenomenonTime: off.phenomenonTime,
                        procedures: off.procedure,
                        procedureDescriptionFormat: off.procedureDescriptionFormat,
                        responseFormat: off.responseFormat,
                        resultTime: off.resultTime
                    }));

                    offeringList[off.identifier] = {
                        featureOfInterestIds: getFOI(off),
                        name: off.name &amp;&amp; off.name[&#x27;#text&#x27;],
                        observedProperties: off.observableProperty,
                        procedures: off.procedure instanceof Array ? off.procedure : [off.procedure],
                        responseFormats: off.responseFormat,
                        responseModes: off.responseFormat,
                        resultModels: [],
                        time: {
                            timePeriod: {
                                beginPosition: off.resultTime &amp;&amp; off.resultTime.timePeriod ? off.resultTime.timePeriod.beginPosition : &#x27;&#x27;,
                                endPosition: off.resultTime &amp;&amp; off.resultTime.timePeriod ? off.resultTime.timePeriod.endPosition : &#x27;&#x27;
                            }
                        }
                    };

                    if (_sos.availableOfferings[i] &amp;&amp; _sos.availableOfferings[i].observedArea)
                        offeringList[off.identifier].bounds = {
                            crs: _sos.availableOfferings[i].observedArea &amp;&amp; _sos.availableOfferings[i].observedArea.crs,
                            bottom: _sos.availableOfferings[i].observedArea.lowerCorner &amp;&amp; _sos.availableOfferings[i].observedArea.lowerCorner.split(&#x27; &#x27;)[0],
                            left: _sos.availableOfferings[i].observedArea.lowerCorner &amp;&amp; _sos.availableOfferings[i].observedArea.lowerCorner.split(&#x27; &#x27;)[1],
                            right: _sos.availableOfferings[i].observedArea.upperCorner &amp;&amp; _sos.availableOfferings[i].observedArea.upperCorner.split(&#x27; &#x27;)[0],
                            top: _sos.availableOfferings[i].observedArea.upperCorner &amp;&amp; _sos.availableOfferings[i].observedArea.upperCorner.split(&#x27; &#x27;)[1]
                        };
                    else offeringList[off.identifier].bounds = {};
                }
            }
        };
        var contentsIsObject = function (c) {
            for (var _off in c) {
                var off = c[_off];
                scope.availableOfferings.push(new SOS.Offering({
                    sos: _sos,
                    bindingType: SOS.bindingType.JSON,
                    identifier: off.identifier,
                    name: off.name &amp;&amp; off.name[&#x27;#text&#x27;] || &#x27;&#x27;,
                    featureOfInterestType: off.featureOfInterestType,
                    featureOfInterestIds: getFOI(off),
                    observedProperties: off.observableProperty,
                    observationType: off.observationType,
                    observedArea: getObservedArea(off),
                    phenomenonTime: off.phenomenonTime,
                    procedures: off.procedure,
                    procedureDescriptionFormat: off.procedureDescriptionFormat,
                    responseFormat: off.responseFormat,
                    resultTime: off.resultTime
                }));

                offeringList[off.identifier] = {
                    featureOfInterestIds: getFOI(off),
                    name: off.name &amp;&amp; off.name[&#x27;#text&#x27;],
                    observedProperties: off.observableProperty,
                    procedures: off.procedure instanceof Array ? off.procedure : [off.procedure],
                    responseFormats: off.responseFormat,
                    responseModes: off.responseFormat,
                    resultModels: [],
                    time: {
                        timePeriod: {
                            beginPosition: off.resultTime &amp;&amp; off.resultTime.timePeriod ? off.resultTime.timePeriod.beginPosition : &#x27;&#x27;,
                            endPosition: off.resultTime &amp;&amp; off.resultTime.timePeriod ? off.resultTime.timePeriod.endPosition : &#x27;&#x27;
                        }
                    }
                };

                if (_sos.availableOfferings[i] &amp;&amp; _sos.availableOfferings[i].observedArea)
                    offeringList[off.identifier].bounds = {
                        crs: _sos.availableOfferings[i].observedArea &amp;&amp; _sos.availableOfferings[i].observedArea.crs,
                        bottom: _sos.availableOfferings[i].observedArea.lowerCorner &amp;&amp; _sos.availableOfferings[i].observedArea.lowerCorner.split(&#x27; &#x27;)[0],
                        left: _sos.availableOfferings[i].observedArea.lowerCorner &amp;&amp; _sos.availableOfferings[i].observedArea.lowerCorner.split(&#x27; &#x27;)[1],
                        right: _sos.availableOfferings[i].observedArea.upperCorner &amp;&amp; _sos.availableOfferings[i].observedArea.upperCorner.split(&#x27; &#x27;)[0],
                        top: _sos.availableOfferings[i].observedArea.upperCorner &amp;&amp; _sos.availableOfferings[i].observedArea.upperCorner.split(&#x27; &#x27;)[1]
                    };
                else offeringList[off.identifier].bounds = {};
            }
        };

        if (capabilities.contents instanceof Array) contentsIsArray(capabilities.contents);
        else contentsIsObject(capabilities.contents);

        if (offeringList)
            capabilities.contents.offeringList = offeringList;
    }
};

SOS.prototype._getOfferings = function (isComplete) {
    var _sos = this;
    var offs = [];

    SOS.OffsCapabilities = SOS.OffsCapabilities || {};

    var capabilities = SOS.OffsCapabilities[_sos.url];
    if (!capabilities) {
        return _sos.getOfferingList(SOS.offeringType.SOS_2);
    }
    else if (capabilities &amp;&amp; !capabilities.contents.offeringList) {
        _sos._bindOfferings(_sos);

        if (!isComplete)
            offs = capabilities.contents.offeringList;
        else
            offs = _sos.availableOfferings;
    }
    else if (!isComplete &amp;&amp; capabilities)
        offs = capabilities.contents.offeringList;
    else if (capabilities)
        offs = _sos.availableOfferings;
    else offs = [];

    return new SOS.Promise(function (resolve, reject) {
        resolve(offs);
    });
};

// Retorna lista de offerings tipado sos 1.0
SOS.prototype.getSimpleOfferings = function () {
    var _sos = this;

    return _sos._getOfferings(false);
};

// Retorna lista de offerings tipado sos 2.0
SOS.prototype.getOfferings = function () {
    var _sos = this;

    return _sos._getOfferings(true);
};

/**
 * Obtiene los identificadores de los offerings disponibles
 *
 * @method getOfferingIds 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOfferingIds = function () {
    var _sos = this;
    var result = [];

    return new SOS.Promise(function (resolve, reject) {
        _sos.getOfferingList(SOS.offeringType.SOS_2).then(function (offList) {

            if (offList instanceof Array) {
                for (var i = 0; i &lt; offList.length; i++) {
                    var o = offList[i];
                    if (o.identifier) {
                        result.push(o.identifier);
                    }
                }
            }
            else {
                for (var offId in offList) {
                    var o = offList[offId];
                    result.push(o);
                }
            }

            resolve(result);
        });
    });
};

/**
 * Obtiene los nombres de los offerings disponibles
 *
 * @method getOfferingIds 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOfferingNames = function () {
    var _sos = this;
    var result = [];

    return new SOS.Promise(function (resolve, reject) {
        _sos.getOfferingList(SOS.offeringType.SOS_2).then(function (offList) {
            for (var id in offList) {
                result.push(offList[id].name);
            }

            resolve(result);
        });
    });
};

/**
 * Obtiene un offering indicando como filtro el identificador del mismo
 *
 * @method getOffering 
 * @param {string} id offering 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOffering = function (id) {
    var _sos = this;
    var offering;

    return new SOS.Promise(function (resolve, reject) {
        if (_sos.availableOfferings) {
            for (var i = 0; i &lt; _sos.availableOfferings.length; i++) {
                if (_sos.availableOfferings[i].identifier.toLowerCase() == id.toLowerCase()) {
                    offering = _sos.availableOfferings[i];
                    break;
                }
            }
        } else {
            _sos.getOfferingList(SOS.offeringType.SOS_2).then(function (offList) {
                _sos.getOffering(id);
            });
        }

        resolve(offering);
    });
};

/**
 * Obtiene un offering indicando como filtro el nombre del mismo
 *
 * @method getOffering 
 * @param {string} nombre offering 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOfferingByName = function (name) {
    var _sos = this;
    var offering;

    return new SOS.Promise(function (resolve, reject) {
        if (_sos.availableOfferings) {
            for (var i = 0; i &lt; _sos.availableOfferings.length; i++) {
                if (_sos.availableOfferings[i].name.toLowerCase() == name.toLowerCase())
                    resolve(_sos.availableOfferings[i]);
            }
        } else {
            _sos.getOfferingList(SOS.offeringType.SOS_2).then(function (offList) {
                if (offList) {
                    for (var off in offList) {
                        if (off.name.toLowerCase() == name.toLowerCase())
                            resolve(off);
                    }
                }
            });
        }

        resolve(offering);
    });
};

/**
 * Obtiene lista de offerings que tengan como procedimiento el indicando como filtro
 *
 * @method getOfferingsForProcedureId 
 * @param {string} procedureId 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOfferingsForProcedureId = function (procedureId) {
    var _sos = this;
    var result = [];

    return new SOS.Promise(function (resolve, reject) {
        _sos.getOfferingIds().then(function (offIds) {
            for (var i = 0; i &lt; offIds.length; i++) {
                var offering = _sos.getOffering(offIds[i]);
                var procIds = offering.getProcedureIds();

                for (var j = 0; j &lt; procIds.length; j++) {
                    if (procIds[j] == procedureId) {
                        result.push(offering);
                        break;
                    }
                }
            }

            resolve(result);
        });
    });
};

///**
// * Get the feature-of-interest (FOI) IDs
// */
//SOS.prototype.getFeatureOfInterestIds = function () {
//    var _sos = this;
//    var result = [];

//    if (_sos.haveValidCapabilitiesObject()) {
//        for (var id in _sos.capsFormatter.data.contents.offeringList) {
//            var offering = _sos.capsFormatter.data.contents.offeringList[id];
//            result = result.concat(offering.featureOfInterestIds);
//        }
//        result = SOS.Utils.getUniqueList(result);
//    }

//    return result;
//};

/**
 * Obtiene lista de offerings que tengan relación con el featureOfInterest indicando como filtro
 *
 * @method getOfferingsForFeatureOfInterestId 
 * @param {string} foiId 
 * @return {SOS.Promise} Promesa 
 */
SOS.prototype.getOfferingsForFeatureOfInterestId = function (foiId) {
    var _sos = this;
    var result = [];

    return new SOS.Promise(function (resolve, reject) {
        _sos.getOfferingList(SOS.offeringType.SOS_2).then(function (offList) {
            if (offList instanceof Array) {
                for (var i = 0; i &lt; offList.length; i++) {
                    var o = offList[i];
                    if (o.featureOfInterestIds &amp;&amp; o.featureOfInterestIds instanceof Array &amp;&amp; o.featureOfInterestIds.indexOf(foiId) &gt; -1) {
                        _sos.getOffering(o.identifier).then(function (off) {
                            result.push(off);
                        });
                    }
                }
            }
            else {
                for (var offId in offList) {
                    var o = offList[offId];

                    if (o.featureOfInterestIds &amp;&amp; o.featureOfInterestIds instanceof Array &amp;&amp; o.featureOfInterestIds.indexOf(foiId) &gt; -1) {
                        _sos.getOffering(offId).then(function (off) {
                            result.push(off);
                        });
                    }
                }
            }

            resolve(result);
        });
    });
};

/**
 * Get the latest observations for a given FOI
 */
SOS.prototype.getLatestObservationsForFeatureOfInterestId = function (foiId) {
    var _sos = this;

    // If foiId is set, then it&#x27;s sent in latest obs request
    _sos.foiId = foiId;
    _sos.getOfferingsForFeatureOfInterestId(foiId).then(function (offerings) {
        // Get obs for any offerings that have the given FOI
        for (var i = 0, len = offerings.length; i &lt; len; i++) {
            _sos.getLatestObservationsForOffering(offerings[i]);
        }
    });
};

/**
 * Get the latest observations for a given SOS.Offering object
 */
SOS.prototype.getLatestObservationsForOffering = function (offering) {
    var _sos = this;

    var params = {
        offering: offering.id,
        observedProperties: offering.observedProperties
    };

    if (_sos.foiId)
        params.foi = { featuresOfInterest: _sos.foiId };

    _sos.obsFormatter.getObservationLatest(params);
};

/**
 * Get requested observations for a given SOS.Offering object
 * between given start and end datetimes
 */
SOS.prototype.getObservationsForOffering = function (offering, start, end) {
    var _sos = this;

    var params = {
        offering: offering.id,
        observedProperties: offering.observedProperties
    };

    if (_sos.foiId)
        params.foi = { featuresOfInterest: _sos.foiId };

    _sos.obsFormatter.getObservationFirst(params);
};

/**
 * Validate the internal observations object
 */
SOS.prototype.haveValidObservationsObject = function () {
    var _sos = this;

    return SOS.Utils.isValidObject(_sos.SOSObservations);
};

/**
 * Get a count of the number of records contained in the internal
 * observations object
 */
SOS.prototype.getCountOfObservations = function () {
    var _sos = this;
    var n = 0;

    if (_sos.haveValidObservationsObject()) {
        if (SOS.Utils.isValidObject(_sos.SOSObservations.measurements)) {
            n = _sos.SOSObservations.measurements.length;
        }
    }

    return n;
};

/**
 * Get the observation for the given index from the internal
 * observations object
 */
SOS.prototype.getObservationRecord = function (i) {
    var _sos = this;
    var record = {};

    if (_sos.haveValidObservationsObject()) {
        record = _sos.SOSObservations.measurements[i];

        // Add some convenience properties
        record = _sos.addPropertiesToObservationRecord(record);
    }

    return record;
};

/**
 * Get the observation for the given index from the internal
 * observations object, as long as it matches the given filter rules
 */
SOS.prototype.getFilteredObservationRecord = function (i, filter) {
    var _sos = this;
    var record;

    if (_sos.haveValidObservationsObject()) {
        var r = _sos.SOSObservations.measurements[i];

        if (SOS.Utils.isValidObject(filter)) {
            if (SOS.Utils.isValidObject(filter.foiId)) {
                var foi = _sos.getFeatureOfInterestFromObservationRecord(r);

                if (foi &amp;&amp; foi.attributes.id == filter.foiId) {
                    record = _sos.SOSObservations.measurements[i];
                }
            } else if (SOS.Utils.isValidObject(filter.observedProperty)) {
                if (r.observedProperty == filter.observedProperty) {
                    record = _sos.SOSObservations.measurements[i];
                }
            }
        } else {
            record = _sos.SOSObservations.measurements[i];
        }

        // Add some convenience properties
        record = _sos.addPropertiesToObservationRecord(record);
    }

    return record;
};

/**
 * Add some standard properties to the given observation record
 */
SOS.prototype.addPropertiesToObservationRecord = function (record) {
    if (SOS.Utils.isValidObject(record)) {
        record.time = record.samplingTime.timeInstant.timePosition;
        record.observedPropertyTitle = SOS.Utils.toTitleCase(SOS.Utils.toDisplayName(SOS.Utils.fqnToName(record.observedProperty)));
        record.uomTitle = SOS.Utils.toDisplayUom(record.result.uom);
    }

    return record;
};

/**
 * Ascertain that the given observation record has FOI properties
 */
SOS.prototype.observationRecordHasValidFeatureOfInterest = function (ob, opts) {
    var opts = opts || { foisIndex: 0, featuresIndex: 0 };

    return (SOS.Utils.isValidObject(ob.fois) &amp;&amp;
            SOS.Utils.isValidObject(ob.fois[opts.foisIndex]) &amp;&amp;
            SOS.Utils.isValidObject(ob.fois[opts.foisIndex].features) &amp;&amp;
            SOS.Utils.isValidObject(ob.fois[opts.foisIndex].features[opts.featuresIndex]));
};

/**
 * Get the FOI object from the given observation record
 */
SOS.prototype.getFeatureOfInterestFromObservationRecord = function (ob, opts) {
    var opts = opts || { foisIndex: 0, featuresIndex: 0 };

    return ob.fois[opts.foisIndex].features[opts.featuresIndex];
};

/**
 * Get details for the given FOI
 */
SOS.prototype.getFeatureOfInterest = function (foiId) {
    var _sos = this;

    _sos.foiFormatter.getFeatureOfInterest({ featureOfInterest: foiId });
};

/**
 * Get the description for the given procedure
 */
SOS.prototype.describeSensor = function (procedureId) {
    var _sos = this;

    var params = {
        idProcedure: procedureId
    };

    _sos.sensorDescFormatter.getDescribeSensor(params);
};



    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
